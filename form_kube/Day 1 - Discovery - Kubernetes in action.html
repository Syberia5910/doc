<!DOCTYPE html>
<!-- saved from url=(0081)http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/ -->
<html lang="en" class="js-focus-visible js" data-js-focus-visible=""><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><style></style>
    
      
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      <link rel="icon" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.2.4, mkdocs-material-8.1.1">
    
    
      
        <title>Day 1 - Discovery - Kubernetes in action</title>
      
    
    
      <link rel="stylesheet" href="./Day 1 - Discovery - Kubernetes in action_files/main.23b6d78a.min.css">
      
        
        <link rel="stylesheet" href="./Day 1 - Discovery - Kubernetes in action_files/palette.e6a45f82.min.css">
        
          
          
          <meta name="theme-color" content="#e92063">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin="">
        <link rel="stylesheet" href="./Day 1 - Discovery - Kubernetes in action_files/css">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="pink" data-md-color-accent="">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#day-1-discover-kubernetes" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/" title="Kubernetes in action" class="md-header__button md-logo" aria-label="Kubernetes in action" data-md-component="logo">
      
  <img src="./Day 1 - Discovery - Kubernetes in action_files/logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"></path></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Kubernetes in action
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Day 1 - Discovery
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"></path></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required="">
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"></path></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"></path></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"></path></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap">
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">Type to start searching</div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  
  


  <li class="md-tabs__item">
    <a href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/" class="md-tabs__link">
      Briefing
    </a>
  </li>

      
        
  
  
    
  


  
  
  
    <li class="md-tabs__item">
      <a href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/" class="md-tabs__link md-tabs__link--active">
        TP
      </a>
    </li>
  

      
        
  
  


  <li class="md-tabs__item">
    <a href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/cheatsheet/" class="md-tabs__link">
      Cheatsheet
    </a>
  </li>

      
        
  
  


  <li class="md-tabs__item">
    <a href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/about/" class="md-tabs__link">
      About
    </a>
  </li>

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" style="top: 48px;">
                <div class="md-sidebar__scrollwrap" style="height: 472px;">
                  <div class="md-sidebar__inner">
                    

  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/" title="Kubernetes in action" class="md-nav__button md-logo" aria-label="Kubernetes in action" data-md-component="logo">
      
  <img src="./Day 1 - Discovery - Kubernetes in action_files/logo.png" alt="logo">

    </a>
    Kubernetes in action
  </label>
  
  <ul class="md-nav__list">
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/" class="md-nav__link">
        Briefing
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" checked="">
      
      
      
      
        <label class="md-nav__link" for="__nav_2">
          TP
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="TP" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          TP
        </label>
        <ul class="md-nav__list">
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Day 1 - Discovery
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/" class="md-nav__link md-nav__link--active">
        Day 1 - Discovery
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc">
      
        <li class="md-nav__item">
  <a href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#initialisation-des-outils" class="md-nav__link">
    Initialisation des outils
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#installation-dun-editeur-de-code" class="md-nav__link">
    Installation d'un Ã©diteur de code
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#installation-de-kubectl" class="md-nav__link">
    Installation de kubectl
  </a>
  
    <nav class="md-nav" aria-label="Installation de kubectl">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#linux-macos" class="md-nav__link">
    Linux / MacOS
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#windows" class="md-nav__link">
    Windows
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#kubeconfig" class="md-nav__link">
    Kubeconfig
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#lens" class="md-nav__link">
    Lens
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#premieres-commandes" class="md-nav__link">
    PremiÃ¨res commandes
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#etape-1-premieres-ressources-podsreplicasetdeployment" class="md-nav__link">
    Ãtape 1 : PremiÃ¨res ressources : Pods/Replicaset/Deployment
  </a>
  
    <nav class="md-nav" aria-label="Ãtape 1 : PremiÃ¨res ressources : Pods/Replicaset/Deployment">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#pods" class="md-nav__link">
    Pods
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#pod-yaml-definition" class="md-nav__link">
    Pod Yaml Definition
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#imperatif-vs-declaratif" class="md-nav__link">
    ImpÃ©ratif Vs DÃ©claratif
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#replicaset" class="md-nav__link">
    Replicaset
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#deployment" class="md-nav__link">
    Deployment
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#faire-un-rollback" class="md-nav__link">
    Faire un Rollback
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#mettre-a-lechelle" class="md-nav__link">
    Mettre Ã  l'Ã©chelle
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#mettre-en-standby-un-deployment" class="md-nav__link">
    Mettre en standby un deployment
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#bonus" class="md-nav__link">
    Bonus
  </a>
  
    <nav class="md-nav" aria-label="Bonus">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#impact-des-limites-memoire" class="md-nav__link">
    Impact des limites MÃ©moire
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#impact-des-limites-cpu" class="md-nav__link">
    Impact des limites CPU
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#etape-2-publication-serviceingress" class="md-nav__link">
    Ãtape 2 : Publication Service/Ingress
  </a>
  
    <nav class="md-nav" aria-label="Ãtape 2 : Publication Service/Ingress">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#service" class="md-nav__link">
    Service
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#ingress" class="md-nav__link">
    Ingress
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#bonus_1" class="md-nav__link">
    Bonus
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#mise-en-situation" class="md-nav__link">
    Mise en situation
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#etape-3-configmapsecret" class="md-nav__link">
    Ãtape 3 : ConfigMap/Secret
  </a>
  
    <nav class="md-nav" aria-label="Ãtape 3 : ConfigMap/Secret">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#exemple" class="md-nav__link">
    Exemple :
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#secret" class="md-nav__link">
    Secret
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#bonus_2" class="md-nav__link">
    Bonus
  </a>
  
    <nav class="md-nav" aria-label="Bonus">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#bonus-1-rendre-sa-couleur-secrete" class="md-nav__link">
    Bonus 1 : Rendre sa couleur secrÃ¨te
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#bonus-2-mon-pod-est-il-en-vie" class="md-nav__link">
    Bonus 2 : Mon pod est-il en vie ?
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#bonus-3-let-my-kubernetes-scale" class="md-nav__link">
    Bonus 3 : Let my kubernetes Scale !!!
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#bonus-4-control-my-traffic" class="md-nav__link">
    Bonus 4: Control my traffic !!!
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#bonus-5-run-on-one-az" class="md-nav__link">
    Bonus 5: Run on one AZ
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#bonus-6-run-one-pod-on-each-server" class="md-nav__link">
    Bonus 6: Run one pod on each server
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#bonus-7-change-my-rolling-update-policy" class="md-nav__link">
    Bonus 7: Change my rolling update policy
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch2-deep-dive/" class="md-nav__link">
        Day 2 - Deep Dive
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch3-gitops/" class="md-nav__link">
        Day 3 - GitOps
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch4-monitoring/" class="md-nav__link">
        Day 4 - Monitoring
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/cheatsheet/" class="md-nav__link">
        Cheatsheet
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/about/" class="md-nav__link">
        About
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" style="top: 48px;">
                <div class="md-sidebar__scrollwrap" style="height: 472px;">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc">
      
        <li class="md-nav__item">
  <a href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#initialisation-des-outils" class="md-nav__link">
    Initialisation des outils
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#installation-dun-editeur-de-code" class="md-nav__link">
    Installation d'un Ã©diteur de code
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#installation-de-kubectl" class="md-nav__link">
    Installation de kubectl
  </a>
  
    <nav class="md-nav" aria-label="Installation de kubectl">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#linux-macos" class="md-nav__link">
    Linux / MacOS
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#windows" class="md-nav__link">
    Windows
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#kubeconfig" class="md-nav__link">
    Kubeconfig
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#lens" class="md-nav__link">
    Lens
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#premieres-commandes" class="md-nav__link">
    PremiÃ¨res commandes
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#etape-1-premieres-ressources-podsreplicasetdeployment" class="md-nav__link">
    Ãtape 1 : PremiÃ¨res ressources : Pods/Replicaset/Deployment
  </a>
  
    <nav class="md-nav" aria-label="Ãtape 1 : PremiÃ¨res ressources : Pods/Replicaset/Deployment">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#pods" class="md-nav__link">
    Pods
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#pod-yaml-definition" class="md-nav__link">
    Pod Yaml Definition
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#imperatif-vs-declaratif" class="md-nav__link">
    ImpÃ©ratif Vs DÃ©claratif
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#replicaset" class="md-nav__link">
    Replicaset
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#deployment" class="md-nav__link">
    Deployment
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#faire-un-rollback" class="md-nav__link">
    Faire un Rollback
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#mettre-a-lechelle" class="md-nav__link">
    Mettre Ã  l'Ã©chelle
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#mettre-en-standby-un-deployment" class="md-nav__link">
    Mettre en standby un deployment
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#bonus" class="md-nav__link">
    Bonus
  </a>
  
    <nav class="md-nav" aria-label="Bonus">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#impact-des-limites-memoire" class="md-nav__link">
    Impact des limites MÃ©moire
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#impact-des-limites-cpu" class="md-nav__link">
    Impact des limites CPU
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#etape-2-publication-serviceingress" class="md-nav__link">
    Ãtape 2 : Publication Service/Ingress
  </a>
  
    <nav class="md-nav" aria-label="Ãtape 2 : Publication Service/Ingress">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#service" class="md-nav__link">
    Service
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#ingress" class="md-nav__link">
    Ingress
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#bonus_1" class="md-nav__link">
    Bonus
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#mise-en-situation" class="md-nav__link">
    Mise en situation
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#etape-3-configmapsecret" class="md-nav__link">
    Ãtape 3 : ConfigMap/Secret
  </a>
  
    <nav class="md-nav" aria-label="Ãtape 3 : ConfigMap/Secret">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#exemple" class="md-nav__link">
    Exemple :
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#secret" class="md-nav__link">
    Secret
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#bonus_2" class="md-nav__link">
    Bonus
  </a>
  
    <nav class="md-nav" aria-label="Bonus">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#bonus-1-rendre-sa-couleur-secrete" class="md-nav__link">
    Bonus 1 : Rendre sa couleur secrÃ¨te
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#bonus-2-mon-pod-est-il-en-vie" class="md-nav__link">
    Bonus 2 : Mon pod est-il en vie ?
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#bonus-3-let-my-kubernetes-scale" class="md-nav__link">
    Bonus 3 : Let my kubernetes Scale !!!
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#bonus-4-control-my-traffic" class="md-nav__link">
    Bonus 4: Control my traffic !!!
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#bonus-5-run-on-one-az" class="md-nav__link">
    Bonus 5: Run on one AZ
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#bonus-6-run-one-pod-on-each-server" class="md-nav__link">
    Bonus 6: Run one pod on each server
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#bonus-7-change-my-rolling-update-policy" class="md-nav__link">
    Bonus 7: Change my rolling update policy
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                

<h1 id="day-1-discover-kubernetes">Day 1: Discover Kubernetes</h1>
<h2 id="initialisation-des-outils">Initialisation des outils</h2>
<p>Vous avez dÃ» recevoir un petit cadeau dans votre boÃ®te mail nommÃ© <code>kubeconfig</code>.
Ce fichier est la clef dâaccÃ¨s au cluster Kubernetes qui a Ã©tÃ© spÃ©cialement provisionnÃ© pour que vous puissiez vous amuser Ã  dÃ©ployer des ressources, publier des services et les scaler.
Pour pouvoir lâutiliser, vous devrez dâabord installer kubectl. Il sâagit de l'outil dâadministration en ligne de commande (CLI) pour manager Kubernetes.</p>
<h2 id="installation-dun-editeur-de-code">Installation d'un Ã©diteur de code</h2>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Il est conseillÃ© d'installer un Ã©diteur de code complet pour l'Ã©dition des fichiers tout au long de cette formation.</p>
</div>
<p>Si vous n'en avez pas, vous pouvez utiliser <a href="https://code.visualstudio.com/" target="_blank">VsCode</a> .</p>
<h2 id="installation-de-kubectl">Installation de kubectl</h2>
<h3 id="linux-macos">Linux / MacOS</h3>
<p>TÃ©lÃ©chargez le client : 
</p><div class="highlight"><pre id="__code_1"><span></span><button class="md-clipboard md-icon" title="Copy to clipboard" data-clipboard-target="#__code_1 &gt; code"></button><code tabindex="0"><a id="__codelineno-0-1" name="__codelineno-0-1" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-0-1"></a>curl<span class="w"> </span>-LO<span class="w"> </span><span class="s2">"https://dl.k8s.io/release/</span><span class="k">$(</span>curl<span class="w"> </span>-L<span class="w"> </span>-s<span class="w"> </span>https://dl.k8s.io/release/stable.txt<span class="k">)</span><span class="s2">/bin/linux/amd64/kubectl"</span>
</code></pre></div><p></p>
<p>Le rendre exÃ©cutable :
</p><div class="highlight"><pre id="__code_2"><span></span><button class="md-clipboard md-icon" title="Copy to clipboard" data-clipboard-target="#__code_2 &gt; code"></button><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-1-1"></a>chmod<span class="w"> </span>+x<span class="w"> </span>./kubectl
</code></pre></div><p></p>
<p>DÃ©placez le binaire dans votre PATH :
</p><div class="highlight"><pre id="__code_3"><span></span><button class="md-clipboard md-icon" title="Copy to clipboard" data-clipboard-target="#__code_3 &gt; code"></button><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-2-1"></a>sudo<span class="w"> </span>mv<span class="w"> </span>./kubectl<span class="w"> </span>/usr/local/bin/kubectl
</code></pre></div><p></p>
<p>Testez pour vous assurer que la version que vous avez installÃ©e est Ã  jour :
</p><div class="highlight"><pre id="__code_4"><span></span><button class="md-clipboard md-icon" title="Copy to clipboard" data-clipboard-target="#__code_4 &gt; code"></button><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-3-1"></a>kubectl<span class="w"> </span>version<span class="w"> </span>--client
</code></pre></div><p></p>
<h3 id="windows">Windows</h3>
<p>TÃ©lÃ©chargez le client :
</p><div class="highlight"><pre id="__code_5"><span></span><button class="md-clipboard md-icon" title="Copy to clipboard" data-clipboard-target="#__code_5 &gt; code"></button><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-4-1"></a>curl.exe<span class="w"> </span>-LO<span class="w"> </span><span class="s2">"https://dl.k8s.io/release/v1.29.1/bin/windows/amd64/kubectl.exe"</span>
</code></pre></div><p></p>
<p>Ajoutez l'exÃ©cutable dans le PATH.
<a href="https://www.malekal.com/variables-environnement-windows/" target="_blank">Tutoriel sous Windows 10</a></p>
<p>Testez pour vous assurer que la version que vous avez installÃ©e est Ã  jour :
</p><div class="highlight"><pre id="__code_6"><span></span><button class="md-clipboard md-icon" title="Copy to clipboard" data-clipboard-target="#__code_6 &gt; code"></button><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-5-1"></a>kubectl<span class="w"> </span>version<span class="w"> </span>--client
</code></pre></div><p></p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Nous recommandons vivement de mettre en place l'autocompletion qui simplifiera beaucoup l'usage de du CLI kubectl :
<a href="https://kubernetes.io/docs/tasks/tools/install-kubectl-linux/#enable-shell-autocompletion" target="_blank">lien pour la mise en place ici</a>
Choisissez le bon onglet en fonction du shell que vous utilisez</p>
</div>
<h2 id="kubeconfig">Kubeconfig</h2>
<p>Votre client Kubectl est maintenant opÃ©rationnel. Pour administrer un cluster Kubernetes, vous allez devoir utiliser les informations de connexion prÃ©sentes dans le fichier kubeconfig. Pour cela, vous devez simplement placer ce fichier dans <code>$HOME/.kube/config</code>.</p>
<div class="admonition question">
<p class="admonition-title">Question</p>
<p>Quelles sont les informations que l'on retrouve dans ce fichier ?</p>
</div>
<h2 id="lens">Lens</h2>
<p>Lens est un IDE (Integrated Development Environment) qui permet d'administrer localement plusieurs clusters kubernetes. Cela vous permettra d'avoir une visualisation des ressources crÃ©Ã©es et de pouvoir les Ã©diter (mÃªme si on va privilÃ©gier le CLI kubectl)</p>
<p>Pour ce cours, vous pouvez utiliser la version Open Source nommÃ©e OpenLens : https://github.com/MuhammedKalkan/OpenLens</p>
<h2 id="premieres-commandes">PremiÃ¨res commandes</h2>
<p>Super ! Vous Ãªtes maintenant prÃªt Ã  utiliser Kubernetes. Comme tout bon outil dâadministration, kubectl propose un helper assez fourni. Vous pouvez y jeter un coup d'Åil :</p>
<div class="highlight"><pre id="__code_7"><span></span><button class="md-clipboard md-icon" title="Copy to clipboard" data-clipboard-target="#__code_7 &gt; code"></button><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-6-1"></a>kubectl<span class="w"> </span>-h
</code></pre></div>
<p>La doc suivante est Ã©galement trÃ¨s intÃ©ressante pour approfondir l'utilisation de kubectl : <a href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/kubectl%20CheatSheet" target="_blank">https://kubernetes.io/docs/reference/kubectl/cheatsheet/</a></p>
<p>Assurez-vous d'Ãªtre dans le bon context (bon cluster kubernetes utilisÃ©) :</p>
<div class="highlight"><pre id="__code_8"><span></span><button class="md-clipboard md-icon" title="Copy to clipboard" data-clipboard-target="#__code_8 &gt; code"></button><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-7-1"></a>kubectl<span class="w"> </span>config<span class="w"> </span>view
<a id="__codelineno-7-2" name="__codelineno-7-2" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-7-2"></a>kubectl<span class="w"> </span>config<span class="w"> </span>current-context
</code></pre></div>
<p>Pour commencer, il faut savoir que Kubernetes fonctionne avec des <code>Namespaces</code> pour sÃ©parer de maniÃ¨re logique les ressources. Cela permet de sÃ©parer les projets ou les environnements par exemple et de dÃ©finir des droits utilisateur sur chacun dâentre eux.</p>
<p>Dans le cadre de cet atelier, vous aurez accÃ¨s Ã  un <code>Namespace</code> personnel qui a pour libellÃ© votre username : si votre mail est toto@exemple.com, votre namespace se nommera toto.</p>
<p>Maintenant, essayez de connaÃ®tre les pods qui tournent dans votre namespace :</p>
<div class="highlight"><pre id="__code_9"><span></span><button class="md-clipboard md-icon" title="Copy to clipboard" data-clipboard-target="#__code_9 &gt; code"></button><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-8-1"></a>kubectl<span class="w"> </span>get<span class="w"> </span>pods<span class="w"> </span>-n<span class="w"> </span>votre_namespace
</code></pre></div>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>Ici un "No resources found ..." tÃ©moigne d'un succÃ¨s de l'appel Ã  l'api kubernetes. Il n'y a simplement pas de Pod Ã  lister, pour le moment...</p>
</div>
<p>Maintenant, essayez la mÃªme commande sur un autre namespace :</p>
<div class="highlight"><pre id="__code_10"><span></span><button class="md-clipboard md-icon" title="Copy to clipboard" data-clipboard-target="#__code_10 &gt; code"></button><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-9-1"></a>kubectl<span class="w"> </span>get<span class="w"> </span>pods<span class="w"> </span>-n<span class="w"> </span>default
</code></pre></div>
<div class="admonition question">
<p class="admonition-title">Question</p>
<p>Quelle est la diffÃ©rence ?</p>
</div>
<h2 id="etape-1-premieres-ressources-podsreplicasetdeployment">Ãtape 1 : PremiÃ¨res ressources : Pods/Replicaset/Deployment</h2>
<h3 id="pods">Pods</h3>
<p>Dans le monde Kubernetes, TOUT est ressource : un dÃ©ploiement est une ressource, un pod est une ressource, une configuration est une ressource, un disque est une ressource, etc. Tous ces objets Kubernetes peuvent Ãªtre dÃ©crits dans un fichier (souvent un fichier yaml).</p>
<p>Le <code>Pod</code> est la ressource minimale et triviale quâil est possible de dÃ©ployer dans Kubernetes en termes de ressources applicatives. Pour faire simple, un pod est une ressource qui hÃ©berge un ou plusieurs containers. Comme pour un conteneur dÃ©marrÃ© avec Docker, vous devez dÃ©finir une image Docker Ã  consommer, des variables, des volumes. Par exemple :</p>
<div class="highlight"><pre id="__code_11"><span></span><button class="md-clipboard md-icon" title="Copy to clipboard" data-clipboard-target="#__code_11 &gt; code"></button><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-10-1"></a>kubectl<span class="w"> </span>run<span class="w"> </span>mynginx<span class="w"> </span>--image<span class="w"> </span>registry.takima.io/school/proxy/nginx
</code></pre></div>
<p>Pour chaque ressource, nous proposerons un lien qui renvoie vers la documentation officielle de Kubernetes, qui est une source fiable et souvent utile pour se renseigner sur les diffÃ©rentes caractÃ©ristiques des ressources.</p>
<p>Pour le Pod, c'est par ici : <a href="https://kubernetes.io/docs/concepts/workloads/pods/" target="_blank">https://kubernetes.io/docs/concepts/workloads/pods/</a></p>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>DerriÃ¨re cette commande, un fichier json de type POD est gÃ©nÃ©rÃ© et est envoyÃ© au KubeApi pour la crÃ©ation.</p>
</div>
<p>Observez la crÃ©ation du pod :</p>
<div class="highlight"><pre id="__code_12"><span></span><button class="md-clipboard md-icon" title="Copy to clipboard" data-clipboard-target="#__code_12 &gt; code"></button><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-11-1"></a>kubectl<span class="w"> </span>get<span class="w"> </span>pods<span class="w"> </span>mynginx
</code></pre></div>
<p>Vous pouvez aussi dÃ©crire le fichier yaml qui dÃ©fini le pod :</p>
<div class="highlight"><pre id="__code_13"><span></span><button class="md-clipboard md-icon" title="Copy to clipboard" data-clipboard-target="#__code_13 &gt; code"></button><code><a id="__codelineno-12-1" name="__codelineno-12-1" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-12-1"></a>kubectl<span class="w"> </span>get<span class="w"> </span>pods<span class="w"> </span>mynginx<span class="w"> </span>-o<span class="w"> </span>yaml
</code></pre></div>
<div class="admonition question">
<p class="admonition-title">Question</p>
<p>Quelles sont les propriÃ©tÃ©s principales que l'on retrouve ?</p>
</div>
<p>Vous retrouvez dans les root properties :</p>
<ul>
<li>apiVersion</li>
<li>kind</li>
<li>metadata</li>
<li>spec</li>
</ul>
<p>Maintenant, dÃ©truisez le pod :</p>
<div class="highlight"><pre id="__code_14"><span></span><button class="md-clipboard md-icon" title="Copy to clipboard" data-clipboard-target="#__code_14 &gt; code"></button><code><a id="__codelineno-13-1" name="__codelineno-13-1" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-13-1"></a>kubectl<span class="w"> </span>delete<span class="w"> </span>pods<span class="w"> </span>nom_du_pod
</code></pre></div>
<p>VoilÃ , vous avez crÃ©Ã© et supprimÃ© votre premiÃ¨re ressource dans kubernetes. Ce n'est pas si compliquÃ© n'est-ce pas ?</p>
<h3 id="pod-yaml-definition">Pod Yaml Definition</h3>
<p>Nous allons imaginer une application vide, qui s'appelle Unicorn. Pour l'instant, <strong>Unicorn</strong> n'est qu'un conteneur Nginx tout vide, c'est un <strong>front</strong>.</p>
<p>Par soucis de convention, nous vous proposons de crÃ©er un fichier <code>unicorn-front-pod.yml</code></p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Comme dans kubernetes TOUT est ressource yaml, nous te conseillons de crÃ©er un dossier et une arborescence pour pouvoir les Ã©diter et les modifier. par exemple <code>TP-kube-01/step-1</code> dans lequel vous placerez vos ressources yaml manipulÃ©es.</p>
</div>
<p>Pour appliquer une ressource kubernetes dÃ©crite en tant que yaml la commande est toujours la mÃªme : <code>kubectl apply -f monfichier.yml</code></p>
<p>Ã vous de jouer. Essayez de crÃ©er la mÃªme ressource avec un fichier yaml :</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Pour avoir le yaml correspondant Ã  une ressource Ã  crÃ©er, vous pouvez utiliser la fonction dry-run, exemple :</p>
<div class="highlight"><pre id="__code_15"><span></span><button class="md-clipboard md-icon" title="Copy to clipboard" data-clipboard-target="#__code_15 &gt; code"></button><code tabindex="0"><a id="__codelineno-14-1" name="__codelineno-14-1" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-14-1"></a>kubectl<span class="w"> </span>run<span class="w"> </span>mynginx2<span class="w"> </span>--image<span class="w"> </span>registry.takima.io/school/proxy/nginx<span class="w"> </span>--dry-run<span class="o">=</span>client<span class="w"> </span>-o<span class="w"> </span>yaml<span class="w"> </span>&gt;<span class="w"> </span>unicorn-front-pod.yml
<a id="__codelineno-14-2" name="__codelineno-14-2" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-14-2"></a>
<a id="__codelineno-14-3" name="__codelineno-14-3" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-14-3"></a><span class="c1"># Pour appliquer une ressource dÃ©crite dans un yaml :</span>
<a id="__codelineno-14-4" name="__codelineno-14-4" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-14-4"></a>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>unicorn-front-pod.yml
</code></pre></div>
<p>Cette commande ne crÃ©era pas le pod dans kubernetes mais dumpera l'Ã©quivalant du
fichier yaml qui aurait Ã©tÃ© envoyÃ© au KubeApi pour la crÃ©ation.
C'est trÃ¨s utile pour avoir un template de ressource voulu et ne pas dÃ©marrer avec un yaml vierge</p>
<p>Il y a Ã©glament une commande <code>kubectl create</code> permettant pour crÃ©er d'autres ressources supportant le <code>--dry-run=client -o yaml</code>
permettant de gÃ©nÃ©rer rapidement les yaml de nos ressources si besoin.</p>
</div>
<p>Comme avec docker, dans kubernetes, vous pouvez accÃ©der Ã  votre conteneur en mode exÃ©cution si besoin (remarquez que lâon retrouve des options Docker) :</p>
<p></p><div class="highlight"><pre id="__code_16"><span></span><button class="md-clipboard md-icon" title="Copy to clipboard" data-clipboard-target="#__code_16 &gt; code"></button><code tabindex="0"><a id="__codelineno-15-1" name="__codelineno-15-1" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-15-1"></a>kubectl<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>nom_du_pod<span class="w"> </span>-it<span class="w"> </span>--<span class="w"> </span>bash
<a id="__codelineno-15-2" name="__codelineno-15-2" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-15-2"></a>
<a id="__codelineno-15-3" name="__codelineno-15-3" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-15-3"></a><span class="c1"># -it pour s'attacher de faÃ§on interactive et avoir la main dans l'invite de commande</span>
<a id="__codelineno-15-4" name="__codelineno-15-4" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-15-4"></a><span class="c1"># -i pour attacher stdin et -t pour faire de stdin un TTY</span>
</code></pre></div>
Pensez Ã  sortir de votre container avec un <code>ctrl + D</code> ou <code>exit</code>.<p></p>
<p>La commande suivante permet de voir les logs :</p>
<div class="highlight"><pre id="__code_17"><span></span><button class="md-clipboard md-icon" title="Copy to clipboard" data-clipboard-target="#__code_17 &gt; code"></button><code><a id="__codelineno-16-1" name="__codelineno-16-1" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-16-1"></a>kubectl<span class="w"> </span>logs<span class="w"> </span>nom_du_pod
</code></pre></div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Avec l'option <code>-f --follow</code> le CLI vous stream les logs sur votre terminal.
</p><div class="highlight"><pre id="__code_18"><span></span><button class="md-clipboard md-icon" title="Copy to clipboard" data-clipboard-target="#__code_18 &gt; code"></button><code><a id="__codelineno-17-1" name="__codelineno-17-1" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-17-1"></a>kubectl<span class="w"> </span>logs<span class="w"> </span>-f<span class="w"> </span>nom_du_pod
</code></pre></div><p></p>
</div>
<p>DÃ©truisez de nouveau le pod :</p>
<div class="highlight"><pre id="__code_19"><span></span><button class="md-clipboard md-icon" title="Copy to clipboard" data-clipboard-target="#__code_19 &gt; code"></button><code><a id="__codelineno-18-1" name="__codelineno-18-1" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-18-1"></a>kubectl<span class="w"> </span>delete<span class="w"> </span>pods<span class="w"> </span>nom_du_pod
</code></pre></div>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>Attention, le pod ne s'appelle plus <code>mynginx</code>, vÃ©rifiez le fichier .yaml gÃ©nÃ©rÃ© prÃ©cÃ©demment.</p>
</div>
<h3 id="imperatif-vs-declaratif">ImpÃ©ratif Vs DÃ©claratif</h3>
<p>Vous venez de voir plusieurs faÃ§ons de crÃ©er une ressource kubernetes :</p>
<ul>
<li><code>kubectl run</code> / <code>kubectl create ...</code></li>
<li><code>kubectl apply -f my-ressources.yaml</code></li>
</ul>
<p>Ces deux faÃ§ons sont bien diffÃ©rentes :</p>
<ul>
<li>La premiÃ¨re est impÃ©rative : elle exÃ©cute ce qu'on lui demande</li>
<li>La seconde est dÃ©clarative : elle s'intÃ©resse Ã  l'Ã©tat que l'on souhaite avoir et rÃ©alise les changements/crÃ©ations nÃ©cessaires</li>
</ul>
<p>De maniÃ¨re gÃ©nÃ©rale, on prÃ©fÃ©rera la mÃ©thode dÃ©clarative pour plusieurs raisons :</p>
<ol>
<li>Lorsque l'on dÃ©ploie des ressources, c'est l'Ã©tat qui nous intÃ©resse, et seuls les changements qui nous sÃ©parent de l'Ã©tat voulu doivent Ãªtre appliquÃ©s.</li>
<li>La mÃ©thode dÃ©clarative s'appuie sur du yaml, permettant ainsi Ã  l'Ã©tat de nos ressources d'Ãªtre dÃ©crit et conservÃ© dans des fichiers (on verra plus tard que c'est trÃ¨s intÃ©ressant).</li>
<li>C'est bien plus riche, tout n'est pas faisable en impÃ©ratif.</li>
</ol>
<p>Pour comprendre une autre diffÃ©rence entre impÃ©ratif et dÃ©claratif, dÃ©ployez un pod :</p>
<div class="highlight"><pre id="__code_20"><span></span><button class="md-clipboard md-icon" title="Copy to clipboard" data-clipboard-target="#__code_20 &gt; code"></button><code><a id="__codelineno-19-1" name="__codelineno-19-1" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-19-1"></a>kubectl<span class="w"> </span>run<span class="w"> </span>mynginx<span class="w"> </span>--image<span class="w"> </span>registry.takima.io/school/proxy/nginx
</code></pre></div>
<p>Maintenant, relancez la mÃªme commande :</p>
<div class="highlight"><pre id="__code_21"><span></span><button class="md-clipboard md-icon" title="Copy to clipboard" data-clipboard-target="#__code_21 &gt; code"></button><code><a id="__codelineno-20-1" name="__codelineno-20-1" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-20-1"></a>kubectl<span class="w"> </span>run<span class="w"> </span>mynginx<span class="w"> </span>--image<span class="w"> </span>registry.takima.io/school/proxy/nginx
</code></pre></div>
<div class="admonition question">
<p class="admonition-title">Question</p>
<p>Que se passe-t-il lors de cette deuxiÃ¨me crÃ©ation en impÃ©ratif ?</p>
</div>
<p>RÃ©alisez la mÃªme crÃ©ation avec la mÃ©thode dÃ©clarative :</p>
<div class="highlight"><pre id="__code_22"><span></span><button class="md-clipboard md-icon" title="Copy to clipboard" data-clipboard-target="#__code_22 &gt; code"></button><code tabindex="0"><a id="__codelineno-21-1" name="__codelineno-21-1" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-21-1"></a>kubectl<span class="w"> </span>run<span class="w"> </span>mynginx<span class="w"> </span>--image<span class="w"> </span>registry.takima.io/school/proxy/nginx<span class="w"> </span>--dry-run<span class="o">=</span>client<span class="w"> </span>-o<span class="w"> </span>yaml<span class="w"> </span>&gt;<span class="w"> </span>mynginx.yml
<a id="__codelineno-21-2" name="__codelineno-21-2" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-21-2"></a>
<a id="__codelineno-21-3" name="__codelineno-21-3" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-21-3"></a>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>mynginx.yml
</code></pre></div>
<div class="admonition question">
<p class="admonition-title">Question</p>
<p>Que se passe-t-il lors de cette deuxiÃ¨me crÃ©ation en dÃ©claratif ?</p>
</div>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>De la mÃªme maniÃ¨re que pour la crÃ©ation de ressources en dÃ©claratif Ã  l'aide d'un fichier yaml, vous pouvez dÃ©truire les ressources Ã  partir du mÃªme fichier yaml. Par exemple dans le cas prÃ©cÃ©dent <code>kubectl delete -f mynginx.yml</code>
Vous pouvez aussi regrouper plusieurs ressources dans un mÃªme yaml pour dÃ©crire une stack complÃ¨te Ã  crÃ©er ou dÃ©truire.</p>
</div>
<h3 id="replicaset">Replicaset</h3>
<p>Ok, câest bien : vous avez rÃ©ussi Ã  dÃ©ployer un conteneur dans un Pod ! Mais qu'en est-il de la haute disponibilitÃ© ou de la scalabilitÃ© promise ?</p>
<p>Pour scaler un applicatif, il faut tout simplement rajouter des <code>Pods</code> du mÃªme applicatif. Vous pourriez crÃ©er Ã  la main plusieurs Pods avec la mÃªme image, mais cela ne serait pas trÃ¨s pratique. Il est beaucoup plus efficace de les regrouper au sein dâun groupe de ressources. Câest dans cet objectif que Kubernetes dÃ©finit les <code>ReplicaSet</code> permettant de contrÃ´ler plusieurs pods dâun mÃªme applicatif (mÃªme image Docker) partageant les mÃªmes configs, les mÃªmes propriÃ©tÃ©s.</p>
<p>Voici un exemple de ressource <a href="https://kubernetes.io/docs/concepts/workloads/controllers/replicaset/" target="_blank">ReplicaSet</a>:</p>
<div class="highlight"><pre id="__code_23"><span></span><button class="md-clipboard md-icon" title="Copy to clipboard" data-clipboard-target="#__code_23 &gt; code"></button><code><a id="__codelineno-22-1" name="__codelineno-22-1" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-22-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">apps/v1</span>
<a id="__codelineno-22-2" name="__codelineno-22-2" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-22-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ReplicaSet</span>
<a id="__codelineno-22-3" name="__codelineno-22-3" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-22-3"></a><span class="nt">metadata</span><span class="p">:</span>
<a id="__codelineno-22-4" name="__codelineno-22-4" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-22-4"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">unicorn-front-replicaset</span>
<a id="__codelineno-22-5" name="__codelineno-22-5" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-22-5"></a><span class="w">  </span><span class="nt">labels</span><span class="p">:</span>
<a id="__codelineno-22-6" name="__codelineno-22-6" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-22-6"></a><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">unicorn-front</span>
<a id="__codelineno-22-7" name="__codelineno-22-7" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-22-7"></a><span class="nt">spec</span><span class="p">:</span>
<a id="__codelineno-22-8" name="__codelineno-22-8" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-22-8"></a><span class="w">  </span><span class="nt">template</span><span class="p">:</span>
<a id="__codelineno-22-9" name="__codelineno-22-9" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-22-9"></a><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span>
<a id="__codelineno-22-10" name="__codelineno-22-10" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-22-10"></a><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">unicorn-front-pod</span>
<a id="__codelineno-22-11" name="__codelineno-22-11" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-22-11"></a><span class="w">      </span><span class="nt">labels</span><span class="p">:</span>
<a id="__codelineno-22-12" name="__codelineno-22-12" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-22-12"></a><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">unicorn-front</span>
<a id="__codelineno-22-13" name="__codelineno-22-13" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-22-13"></a><span class="w">    </span><span class="nt">spec</span><span class="p">:</span>
<a id="__codelineno-22-14" name="__codelineno-22-14" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-22-14"></a><span class="w">      </span><span class="nt">containers</span><span class="p">:</span>
<a id="__codelineno-22-15" name="__codelineno-22-15" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-22-15"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">unicorn-front</span>
<a id="__codelineno-22-16" name="__codelineno-22-16" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-22-16"></a><span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">registry.takima.io/school/proxy/nginx</span>
<a id="__codelineno-22-17" name="__codelineno-22-17" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-22-17"></a><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3</span>
<a id="__codelineno-22-18" name="__codelineno-22-18" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-22-18"></a><span class="w">  </span><span class="nt">selector</span><span class="p">:</span>
<a id="__codelineno-22-19" name="__codelineno-22-19" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-22-19"></a><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span>
<a id="__codelineno-22-20" name="__codelineno-22-20" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-22-20"></a><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">unicorn-front</span>
</code></pre></div>
<div class="admonition question">
<p class="admonition-title">Question</p>
<p>Que remarquez-vous dans la description des properties <code>spec: template</code> ?
Ã quoi sert le <code>selector: matchLabels</code> ?</p>
</div>
<p>Ãditez le yaml <code>unicorn-front-replicaset.yaml</code> et dÃ©ployez ce <code>ReplicaSet</code> sur votre cluster avec <code>kubectl apply</code>.</p>
<div class="admonition question">
<p class="admonition-title">Question</p>
<p>Combien y a-t-il de pods dÃ©ployÃ©s dans votre namespace ?</p>
</div>
<p>Maintenant, supprimez un <code>Pod</code>.</p>
<div class="admonition question">
<p class="admonition-title">Question</p>
<p>Que se passe-t-il ?</p>
</div>
<p>Supprimez le <code>ReplicaSet</code>.</p>
<div class="admonition question">
<p class="admonition-title">Question</p>
<p>Que se passe-t-il ?</p>
</div>
<h3 id="deployment">Deployment</h3>
<p>Une ressource Kubernetes de type <a href="https://kubernetes.io/docs/concepts/workloads/controllers/deployment/" target="_blank">Deployment</a> permet de facilement piloter des <code>ReplicaSet</code>. En pratique, c'est typiquement avec cette ressource que sont dÃ©ployÃ©es les applications.</p>
<p>En effet, le <code>Deployment</code> gÃ¨re la notion de cycle de vie des Pods (via les versions de <code>ReplicaSet</code> pilotÃ©s), notamment avec la dÃ©finition de <code>RollingUpgrade</code> lors dâun dÃ©ploiement de nouvelles versions. Cependant, il faut que la stratÃ©gie par dÃ©faut de <code>RollingUpdate</code> soit conservÃ©e (<code>.spec.strategy.type</code>) : cela facilite les rollbacks vers une version antÃ©rieure.</p>
<p>Lors de la modification de la version dâune image Docker consommÃ©e dans un dÃ©ploiement, un nouveau <code>ReplicaSet</code> sera crÃ©Ã©. Lâancien <code>ReplicaSet</code> correspondant Ã  l'ancienne version de lâimage reste et les Pods sont vidÃ©s de lâancien <code>ReplicaSet</code> vers le nouveau (<code>RollingUpgrade</code>). Ce transfert se fait au âfil de l'eauâ, de maniÃ¨re Ã  ce quâil nây ait pas dâinterruption de service (par dÃ©faut Kubernetes tente de garder 75% des pods actifs). Dans le cas du TP, il ne dÃ©truit les <code>Pods</code> obsolÃ¨tes quâaprÃ¨s que le nouveau <code>Pod</code> obtienne le statut Running.</p>
<p>De cette maniÃ¨re, il est possible de facilement Rollback (processus inverse, les <code>Pods</code> allant du nouveau <code>ReplicaSet</code> vers lâancien).</p>
<p>La crÃ©ation dâun Deployment entraÃ®ne la crÃ©ation dâun ReplicaSet et donc la crÃ©ation dâun ou plusieurs Pods.</p>
<p>La ressource <code>Deployment</code> est trÃ¨s proche de celle dâun <code>ReplicaSet</code> :</p>
<div class="highlight"><pre id="__code_24"><span></span><button class="md-clipboard md-icon" title="Copy to clipboard" data-clipboard-target="#__code_24 &gt; code"></button><code><a id="__codelineno-23-1" name="__codelineno-23-1" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-23-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">apps/v1</span>
<a id="__codelineno-23-2" name="__codelineno-23-2" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-23-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Deployment</span>
<a id="__codelineno-23-3" name="__codelineno-23-3" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-23-3"></a><span class="nt">metadata</span><span class="p">:</span>
<a id="__codelineno-23-4" name="__codelineno-23-4" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-23-4"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">unicorn-front-deployment</span>
<a id="__codelineno-23-5" name="__codelineno-23-5" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-23-5"></a><span class="w">  </span><span class="nt">labels</span><span class="p">:</span>
<a id="__codelineno-23-6" name="__codelineno-23-6" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-23-6"></a><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">unicorn-front</span>
<a id="__codelineno-23-7" name="__codelineno-23-7" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-23-7"></a><span class="nt">spec</span><span class="p">:</span>
<a id="__codelineno-23-8" name="__codelineno-23-8" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-23-8"></a><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3</span>
<a id="__codelineno-23-9" name="__codelineno-23-9" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-23-9"></a><span class="w">  </span><span class="nt">selector</span><span class="p">:</span>
<a id="__codelineno-23-10" name="__codelineno-23-10" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-23-10"></a><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span>
<a id="__codelineno-23-11" name="__codelineno-23-11" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-23-11"></a><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">unicorn-front</span>
<a id="__codelineno-23-12" name="__codelineno-23-12" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-23-12"></a><span class="w">  </span><span class="nt">template</span><span class="p">:</span>
<a id="__codelineno-23-13" name="__codelineno-23-13" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-23-13"></a><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span>
<a id="__codelineno-23-14" name="__codelineno-23-14" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-23-14"></a><span class="w">      </span><span class="nt">labels</span><span class="p">:</span>
<a id="__codelineno-23-15" name="__codelineno-23-15" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-23-15"></a><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">unicorn-front</span>
<a id="__codelineno-23-16" name="__codelineno-23-16" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-23-16"></a><span class="w">    </span><span class="nt">spec</span><span class="p">:</span>
<a id="__codelineno-23-17" name="__codelineno-23-17" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-23-17"></a><span class="w">      </span><span class="nt">containers</span><span class="p">:</span>
<a id="__codelineno-23-18" name="__codelineno-23-18" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-23-18"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">unicorn-front</span>
<a id="__codelineno-23-19" name="__codelineno-23-19" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-23-19"></a><span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">registry.takima.io/school/proxy/nginx:1.7.9</span>
<a id="__codelineno-23-20" name="__codelineno-23-20" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-23-20"></a><span class="w">        </span><span class="nt">ports</span><span class="p">:</span>
<a id="__codelineno-23-21" name="__codelineno-23-21" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-23-21"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">80</span>
</code></pre></div>
<div class="admonition question">
<p class="admonition-title">Question</p>
<p>Quels sont les changements par rapport au <code>ReplicaSet</code> ?</p>
</div>
<p>Ãditez un yaml <code>unicorn-front-deployment.yaml</code> et dÃ©ployez ce <code>Deployment</code>.</p>
<div class="admonition question">
<p class="admonition-title">Question</p>
<p>Combien y a-t'il de <code>ReplicaSet</code> ? De <code>Pods</code> ?</p>
</div>
<p>Commande utile :</p>
<div class="highlight"><pre id="__code_25"><span></span><button class="md-clipboard md-icon" title="Copy to clipboard" data-clipboard-target="#__code_25 &gt; code"></button><code><a id="__codelineno-24-1" name="__codelineno-24-1" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-24-1"></a>kubectl<span class="w"> </span>get<span class="w"> </span>all
</code></pre></div>
<p>Maintenant, la notion dâupgrade : câest en pratique ce quâil se passe lorsque lâon rÃ©alise un dÃ©ploiement applicatif dâune nouvelle release (via un <code>Continuous Deployment</code> par exemple).</p>
<p>Pour cela, changez la version de lâimage nginx :</p>
<p>Modifier une image docker dans un <code>deployment</code> revient Ã  modifier cette ressource deployment.
Pour modifier une ressource, vous avez 3 solutions :</p>
<ol>
<li>
<p><code>kubectl set</code> ou <code>kubectl patch</code></p>
<div class="highlight"><pre id="__code_26"><span></span><button class="md-clipboard md-icon" title="Copy to clipboard" data-clipboard-target="#__code_26 &gt; code"></button><code tabindex="0"><a id="__codelineno-25-1" name="__codelineno-25-1" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-25-1"></a>kubectl<span class="w"> </span><span class="nb">set</span><span class="w"> </span>image<span class="w"> </span>deployment/unicorn-front-deployment<span class="w"> </span>unicorn-front<span class="o">=</span>registry.takima.io/school/proxy/nginx:1.9.1<span class="w"> </span>--record
</code></pre></div>
</li>
<li>
<p>Ãditez le fichier yaml en local et faire un <code>kubectl apply -f monfichier.yaml</code></p>
<p>Il est possible Ã©galement d'Ã©diter le yaml dÃ©finition de dÃ©ploiement en changeant lâimage et d'utiliser cette commande :</p>
<div class="highlight"><pre id="__code_27"><span></span><button class="md-clipboard md-icon" title="Copy to clipboard" data-clipboard-target="#__code_27 &gt; code"></button><code><a id="__codelineno-26-1" name="__codelineno-26-1" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-26-1"></a>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>...
</code></pre></div>
</li>
<li>
<p>Ãditez directement la ressource avec <code>kubectl edit</code></p>
<div class="highlight"><pre id="__code_28"><span></span><button class="md-clipboard md-icon" title="Copy to clipboard" data-clipboard-target="#__code_28 &gt; code"></button><code><a id="__codelineno-27-1" name="__codelineno-27-1" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-27-1"></a>kubectl<span class="w"> </span>edit<span class="w"> </span>deployment.v1.apps/unicorn-front-deployment
</code></pre></div>
</li>
</ol>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>On prÃ©fÃ¨rera rÃ©aliser des updates de ressources en Ã©ditant son fichier yaml (ici unicorn-front-deployment.yaml) en utilisant donc la 2Ã¨me solution. Cela permet d'avoir la bonne version dans son dossier (fichier synchronisÃ© avec ce qui est sur le cluster).</p>
</div>
<p>Regardez le statut du <code>RollingUpgrade</code> :</p>
<div class="highlight"><pre id="__code_29"><span></span><button class="md-clipboard md-icon" title="Copy to clipboard" data-clipboard-target="#__code_29 &gt; code"></button><code><a id="__codelineno-28-1" name="__codelineno-28-1" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-28-1"></a>kubectl<span class="w"> </span>rollout<span class="w"> </span>status<span class="w"> </span>deployment.v1.apps/unicorn-front-deployment
</code></pre></div>
<p>Si vous utilisez la commande rapidement, vous verrez le <code>RollingUpgrade</code> en cours. Si vous n'Ãªtes pas assez rapide vous verrez juste un <code>succesfull</code>.</p>
<div class="admonition question">
<p class="admonition-title">Question</p>
<p>Une fois terminÃ©, combien y a-t-il de replicaset ? Combien y a-t-il de Pods ?
Allez voir les logs des Ã©vÃ©nements du dÃ©ploiement avec <code>kubectl describe deployments</code>. Quâobservez-vous ?</p>
</div>
<p>Commande utile :</p>
<div class="highlight"><pre id="__code_30"><span></span><button class="md-clipboard md-icon" title="Copy to clipboard" data-clipboard-target="#__code_30 &gt; code"></button><code><a id="__codelineno-29-1" name="__codelineno-29-1" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-29-1"></a>kubectl<span class="w"> </span>describe<span class="w"> </span>deployments
</code></pre></div>
<h3 id="faire-un-rollback">Faire un Rollback</h3>
<p>Mettez Ã  jour votre dÃ©ploiement avec une nouvelle version de lâimage nginx.</p>
<div class="highlight"><pre id="__code_31"><span></span><button class="md-clipboard md-icon" title="Copy to clipboard" data-clipboard-target="#__code_31 &gt; code"></button><code tabindex="0"><a id="__codelineno-30-1" name="__codelineno-30-1" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-30-1"></a>kubectl<span class="w"> </span><span class="nb">set</span><span class="w"> </span>image<span class="w"> </span>deployment.v1.apps/unicorn-front-deployment<span class="w"> </span>unicorn-front<span class="o">=</span>registry.takima.io/school/proxy/nginx:1.91-falseimage<span class="w"> </span>--record<span class="o">=</span><span class="nb">true</span>
</code></pre></div>
<p>Observez votre <code>Deployment</code>, vos <code>Pods</code> et vos <code>ReplicaSets</code>.</p>
<div class="admonition question">
<p class="admonition-title">Question</p>
<p>Que se passe-t-il ? Pourquoi ?</p>
</div>
<p>Dans ce cas de figure, l'objectif est de revenir Ã  une version stable de <code>Deployment</code> (une version fonctionnelle avec une bonne image nginx).</p>
<p>Pour commencer, vÃ©rifiez les rÃ©visions de ce dÃ©ploiement :</p>
<div class="highlight"><pre id="__code_32"><span></span><button class="md-clipboard md-icon" title="Copy to clipboard" data-clipboard-target="#__code_32 &gt; code"></button><code><a id="__codelineno-31-1" name="__codelineno-31-1" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-31-1"></a>kubectl<span class="w"> </span>rollout<span class="w"> </span><span class="nb">history</span><span class="w"> </span>deployment.v1.apps/unicorn-front-deployment
</code></pre></div>
<div class="admonition question">
<p class="admonition-title">Question</p>
<p>Combien y a-t-il de rÃ©visions ? Ã quoi correspond le champ <code>CHANGE-CAUSE</code> ?</p>
</div>
<p>Vous pouvez afficher les dÃ©tails de chaque rÃ©vision (pour la rÃ©vision 2 par exemple) avec cette commande :</p>
<div class="highlight"><pre id="__code_33"><span></span><button class="md-clipboard md-icon" title="Copy to clipboard" data-clipboard-target="#__code_33 &gt; code"></button><code><a id="__codelineno-32-1" name="__codelineno-32-1" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-32-1"></a>kubectl<span class="w"> </span>rollout<span class="w"> </span><span class="nb">history</span><span class="w"> </span>deployment.v1.apps/unicorn-front-deployment<span class="w"> </span>--revision<span class="o">=</span><span class="m">2</span>
</code></pre></div>
<p>Maintenant que la version stable est identifiÃ©e, voici la commande pour retourner Ã  cette version :</p>
<div class="highlight"><pre id="__code_34"><span></span><button class="md-clipboard md-icon" title="Copy to clipboard" data-clipboard-target="#__code_34 &gt; code"></button><code><a id="__codelineno-33-1" name="__codelineno-33-1" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-33-1"></a>kubectl<span class="w"> </span>rollout<span class="w"> </span>undo<span class="w"> </span>deployment.v1.apps/unicorn-front-deployment<span class="w"> </span>--to-revision<span class="o">=</span><span class="m">2</span>
</code></pre></div>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>Pour revenir Ã  la version prÃ©cÃ©dente, il est aussi possible d'utiliser cette commande :</p>
</div>
<div class="highlight"><pre id="__code_35"><span></span><button class="md-clipboard md-icon" title="Copy to clipboard" data-clipboard-target="#__code_35 &gt; code"></button><code><a id="__codelineno-34-1" name="__codelineno-34-1" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-34-1"></a>kubectl<span class="w"> </span>rollout<span class="w"> </span>undo<span class="w"> </span>deployment.v1.apps/unicorn-front-deployment
</code></pre></div>
<h3 id="mettre-a-lechelle">Mettre Ã  l'Ã©chelle</h3>
<p>Le dÃ©ploiement de nouvelles versions (releases) est maintenant maÃ®trisÃ©, mais dans l'hypothÃ¨se que le site internet est promu au journal tÃ©lÃ©visÃ© et quâun afflux consÃ©quent de visiteurs se connectent dessus, que faire ? Il faut tout simplement dÃ©ployer plus de <code>Pods</code> de l'applicatif. Câest ce qui est appelÃ© <code>scaler</code> une application.</p>
<p>Scalez le serveur nginx Ã  5 :</p>
<div class="highlight"><pre id="__code_36"><span></span><button class="md-clipboard md-icon" title="Copy to clipboard" data-clipboard-target="#__code_36 &gt; code"></button><code><a id="__codelineno-35-1" name="__codelineno-35-1" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-35-1"></a>kubectl<span class="w"> </span>scale<span class="w"> </span>deployment.v1.apps/unicorn-front-deployment<span class="w"> </span>--replicas<span class="o">=</span><span class="m">5</span>
</code></pre></div>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>Encore une fois cette commande est pratique pour le cadre du TP. Mais en pratique, on prÃ©fÃ¨rera Ã©diter son fichier
yaml de deployment et mettre <code>replicas: 5</code> puis faire un <code>kubectl apply -f unicorn-front-deployment.yaml</code></p>
</div>
<div class="admonition question">
<p class="admonition-title">Question</p>
<p>Combien y a-t'il de <code>Pods</code>?</p>
</div>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>Pour aller plus loin, Kubernetes implÃ©mente, si câest activÃ©, un systÃ¨me dâautoscaling appelÃ© HPA (<code>Horizontal Pods Autoscaling</code>).
Kubernetes se chargera de scaler automatiquement l'application en fonction de trigger dÃ©finis par exemple sur la consommation CPU ou la RAM.
Si vous Ãªtes rapide une implÃ©mentation du HPA est proposÃ© en bonus.</p>
</div>
<h3 id="mettre-en-standby-un-deployment">Mettre en standby un deployment</h3>
<p>Mettez en pause un <code>Deployment</code> :</p>
<div class="highlight"><pre id="__code_37"><span></span><button class="md-clipboard md-icon" title="Copy to clipboard" data-clipboard-target="#__code_37 &gt; code"></button><code tabindex="0"><a id="__codelineno-36-1" name="__codelineno-36-1" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-36-1"></a>kubectl<span class="w"> </span>rollout<span class="w"> </span>pause<span class="w"> </span>deployment.v1.apps/unicorn-front-deployment
<a id="__codelineno-36-2" name="__codelineno-36-2" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-36-2"></a>kubectl<span class="w"> </span><span class="nb">set</span><span class="w"> </span>image<span class="w"> </span>deployment.v1.apps/unicorn-front-deployment<span class="w"> </span>unicorn-front<span class="o">=</span>registry.takima.io/school/proxy/nginx:1.20.2
</code></pre></div>
<div class="admonition question">
<p class="admonition-title">Question</p>
<p>Que se passe-t-il au niveau <code>ReplicaSet</code> ?</p>
</div>
<div class="highlight"><pre id="__code_38"><span></span><button class="md-clipboard md-icon" title="Copy to clipboard" data-clipboard-target="#__code_38 &gt; code"></button><code><a id="__codelineno-37-1" name="__codelineno-37-1" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-37-1"></a>kubectl<span class="w"> </span>rollout<span class="w"> </span>resume<span class="w"> </span>deployment.v1.apps/unicorn-front-deployment
</code></pre></div>
<div class="admonition question">
<p class="admonition-title">Question</p>
<p>Que se passe-t-il au niveau <code>ReplicaSet</code> ?</p>
</div>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>La pause permet de modifier le dÃ©ploiement (encore une autre version, des properties du <code>Deployment</code> comme les limits/ressources) sans dÃ©clencher de <code>RollingUpgrade</code>.</p>
</div>
<h3 id="bonus">Bonus</h3>
<p>Lorsque des applications sont dÃ©ployÃ©es sous forme de containers (dans des Pods), il est indispensable de contrÃ´ler les ressources quâelles consomment. Imaginez quâun Pod se mette Ã  consommer plusieurs dizaines de gigabytes de mÃ©moire vive, quel serait lâimpact sur les autres <code>Pods</code> tournant sur le mÃªme Worker Node (mÃªme serveur) ?</p>
<p>Pour empÃªcher cela, Kubernetes implÃ©mente la notion de Ressources Management.</p>
<div class="admonition example">
<p class="admonition-title">Example</p>
<div class="highlight"><pre id="__code_39"><span></span><button class="md-clipboard md-icon" title="Copy to clipboard" data-clipboard-target="#__code_39 &gt; code"></button><code><a id="__codelineno-38-1" name="__codelineno-38-1" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-38-1"></a><span class="nt">resources</span><span class="p">:</span>
<a id="__codelineno-38-2" name="__codelineno-38-2" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-38-2"></a><span class="w">  </span><span class="nt">requests</span><span class="p">:</span>
<a id="__codelineno-38-3" name="__codelineno-38-3" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-38-3"></a><span class="w">    </span><span class="nt">memory</span><span class="p">:</span><span class="w"> </span><span class="s">"64Mi"</span>
<a id="__codelineno-38-4" name="__codelineno-38-4" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-38-4"></a><span class="w">    </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="s">"250m"</span>
<a id="__codelineno-38-5" name="__codelineno-38-5" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-38-5"></a><span class="w">  </span><span class="nt">limits</span><span class="p">:</span>
<a id="__codelineno-38-6" name="__codelineno-38-6" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-38-6"></a><span class="w">    </span><span class="nt">memory</span><span class="p">:</span><span class="w"> </span><span class="s">"128Mi"</span>
<a id="__codelineno-38-7" name="__codelineno-38-7" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-38-7"></a><span class="w">    </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="s">"500m"</span>
</code></pre></div>
</div>
<p>Ce block se place au niveau <code>spec.container</code>.  </p>
<ul>
<li>Le requests est la ressource qui est demandÃ©e au Worker Node pour allocation au conteneur.</li>
<li>La limits est le maximum de mÃ©moire et CPU consommable par le Pod.</li>
</ul>
<p>ImplÃ©mentez une ressource management pour votre <code>Deployment</code> avec ces spÃ©cifications :</p>
<ul>
<li>Requests : mÃ©moire : 32 Mo / CPU : 100m</li>
<li>Limits : mÃ©moire 256 Mo / CPU : 400m</li>
</ul>
<div class="admonition check">
<p class="admonition-title">Check</p>
<p>Vous devez avoir les fichiers suivants dans le dossier <code>step-1</code> :
</p><div class="highlight"><pre id="__code_40"><span></span><button class="md-clipboard md-icon" title="Copy to clipboard" data-clipboard-target="#__code_40 &gt; code"></button><code><a id="__codelineno-39-1" name="__codelineno-39-1" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-39-1"></a><span class="w">    </span>.
<a id="__codelineno-39-2" name="__codelineno-39-2" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-39-2"></a><span class="w">    </span>âââ<span class="w"> </span>unicorn-front-deployment.yaml
<a id="__codelineno-39-3" name="__codelineno-39-3" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-39-3"></a><span class="w">    </span>âââ<span class="w"> </span>unicorn-front-replicaset.yaml
<a id="__codelineno-39-4" name="__codelineno-39-4" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-39-4"></a><span class="w">    </span>âââ<span class="w"> </span>unicorn-front-pod.yaml
</code></pre></div><p></p>
</div>
<p>Mise en application :</p>
<p>Dans cette mise en application, nous allons voir Ã  quoi servent les ressources limites et quelle est l'impact de ces configurations sur le cycle de vie des containers.</p>
<h4 id="impact-des-limites-memoire">Impact des limites MÃ©moire</h4>
<p>CrÃ©ez le pod suivant :</p>
<div class="highlight"><pre id="__code_41"><span></span><button class="md-clipboard md-icon" title="Copy to clipboard" data-clipboard-target="#__code_41 &gt; code"></button><code><a id="__codelineno-40-1" name="__codelineno-40-1" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-40-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<a id="__codelineno-40-2" name="__codelineno-40-2" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-40-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Pod</span>
<a id="__codelineno-40-3" name="__codelineno-40-3" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-40-3"></a><span class="nt">metadata</span><span class="p">:</span>
<a id="__codelineno-40-4" name="__codelineno-40-4" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-40-4"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">memory-limit</span>
<a id="__codelineno-40-5" name="__codelineno-40-5" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-40-5"></a><span class="nt">spec</span><span class="p">:</span>
<a id="__codelineno-40-6" name="__codelineno-40-6" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-40-6"></a><span class="w">  </span><span class="nt">containers</span><span class="p">:</span>
<a id="__codelineno-40-7" name="__codelineno-40-7" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-40-7"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">memory-limit</span>
<a id="__codelineno-40-8" name="__codelineno-40-8" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-40-8"></a><span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">registry.takima.io/school/proxy/memory-stress</span>
<a id="__codelineno-40-9" name="__codelineno-40-9" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-40-9"></a><span class="w">    </span><span class="nt">resources</span><span class="p">:</span>
<a id="__codelineno-40-10" name="__codelineno-40-10" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-40-10"></a><span class="w">      </span><span class="nt">requests</span><span class="p">:</span>
<a id="__codelineno-40-11" name="__codelineno-40-11" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-40-11"></a><span class="w">        </span><span class="nt">memory</span><span class="p">:</span><span class="w"> </span><span class="s">"50Mi"</span>
<a id="__codelineno-40-12" name="__codelineno-40-12" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-40-12"></a><span class="w">      </span><span class="nt">limits</span><span class="p">:</span>
<a id="__codelineno-40-13" name="__codelineno-40-13" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-40-13"></a><span class="w">        </span><span class="nt">memory</span><span class="p">:</span><span class="w"> </span><span class="s">"100Mi"</span>
<a id="__codelineno-40-14" name="__codelineno-40-14" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-40-14"></a><span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">"stress"</span><span class="p p-Indicator">]</span>
<a id="__codelineno-40-15" name="__codelineno-40-15" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-40-15"></a><span class="w">    </span><span class="nt">args</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">"--vm"</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">"1"</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">"--vm-bytes"</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">"250M"</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">"--vm-hang"</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">"1"</span><span class="p p-Indicator">]</span>
</code></pre></div>
<p>Ce pod simule une application qui rÃ©clame 250M de RAM.</p>
<p>Observez le comportement du pod :</p>
<div class="highlight"><pre id="__code_42"><span></span><button class="md-clipboard md-icon" title="Copy to clipboard" data-clipboard-target="#__code_42 &gt; code"></button><code><a id="__codelineno-41-1" name="__codelineno-41-1" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-41-1"></a>kubectl<span class="w"> </span>get<span class="w"> </span>pod<span class="w"> </span>memory-limit
</code></pre></div>
<div class="admonition question">
<p class="admonition-title">Question</p>
<p>Que constatez-vous ? Pourquoi ?</p>
</div>
<p>Pour voir plus en dÃ©tail :</p>
<div class="highlight"><pre id="__code_43"><span></span><button class="md-clipboard md-icon" title="Copy to clipboard" data-clipboard-target="#__code_43 &gt; code"></button><code><a id="__codelineno-42-1" name="__codelineno-42-1" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-42-1"></a>kubectl<span class="w"> </span>describe<span class="w"> </span>pod<span class="w"> </span>memory-limit
</code></pre></div>
<p>Vous devrez voir ceci :</p>
<div class="highlight"><pre id="__code_44"><span></span><button class="md-clipboard md-icon" title="Copy to clipboard" data-clipboard-target="#__code_44 &gt; code"></button><code><a id="__codelineno-43-1" name="__codelineno-43-1" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-43-1"></a><span class="w"> </span>Last<span class="w"> </span>State:<span class="w">     </span>Terminated
<a id="__codelineno-43-2" name="__codelineno-43-2" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-43-2"></a><span class="w">      </span>Reason:<span class="w">       </span>OOMKilled
</code></pre></div>
<p>DÃ©truisez votre pod</p>
<div class="highlight"><pre id="__code_45"><span></span><button class="md-clipboard md-icon" title="Copy to clipboard" data-clipboard-target="#__code_45 &gt; code"></button><code><a id="__codelineno-44-1" name="__codelineno-44-1" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-44-1"></a>kubectl<span class="w"> </span>delete<span class="w"> </span>pod<span class="w"> </span>memory-limit
</code></pre></div>
<h4 id="impact-des-limites-cpu">Impact des limites CPU</h4>
<p>CrÃ©ez le pod suivant :</p>
<div class="highlight"><pre id="__code_46"><span></span><button class="md-clipboard md-icon" title="Copy to clipboard" data-clipboard-target="#__code_46 &gt; code"></button><code><a id="__codelineno-45-1" name="__codelineno-45-1" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-45-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<a id="__codelineno-45-2" name="__codelineno-45-2" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-45-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Pod</span>
<a id="__codelineno-45-3" name="__codelineno-45-3" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-45-3"></a><span class="nt">metadata</span><span class="p">:</span>
<a id="__codelineno-45-4" name="__codelineno-45-4" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-45-4"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cpu-limit</span>
<a id="__codelineno-45-5" name="__codelineno-45-5" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-45-5"></a><span class="nt">spec</span><span class="p">:</span>
<a id="__codelineno-45-6" name="__codelineno-45-6" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-45-6"></a><span class="w">  </span><span class="nt">containers</span><span class="p">:</span>
<a id="__codelineno-45-7" name="__codelineno-45-7" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-45-7"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cpu-limit</span>
<a id="__codelineno-45-8" name="__codelineno-45-8" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-45-8"></a><span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">registry.takima.io/school/proxy/cpu-stress</span>
<a id="__codelineno-45-9" name="__codelineno-45-9" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-45-9"></a><span class="w">    </span><span class="nt">resources</span><span class="p">:</span>
<a id="__codelineno-45-10" name="__codelineno-45-10" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-45-10"></a><span class="w">      </span><span class="nt">limits</span><span class="p">:</span>
<a id="__codelineno-45-11" name="__codelineno-45-11" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-45-11"></a><span class="w">        </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="s">"1"</span>
<a id="__codelineno-45-12" name="__codelineno-45-12" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-45-12"></a><span class="w">      </span><span class="nt">requests</span><span class="p">:</span>
<a id="__codelineno-45-13" name="__codelineno-45-13" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-45-13"></a><span class="w">        </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="s">"0.5"</span>
<a id="__codelineno-45-14" name="__codelineno-45-14" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-45-14"></a><span class="w">    </span><span class="nt">args</span><span class="p">:</span>
<a id="__codelineno-45-15" name="__codelineno-45-15" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-45-15"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">-cpus</span>
<a id="__codelineno-45-16" name="__codelineno-45-16" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-45-16"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">"2"</span>
</code></pre></div>
<p>Ce pod va simuler une demande d'utilisation de 2 vCPUs.</p>
<p>VÃ©rifiez le comportement du pod :</p>
<div class="highlight"><pre id="__code_47"><span></span><button class="md-clipboard md-icon" title="Copy to clipboard" data-clipboard-target="#__code_47 &gt; code"></button><code><a id="__codelineno-46-1" name="__codelineno-46-1" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-46-1"></a>kubectl<span class="w"> </span>get<span class="w"> </span>pod<span class="w"> </span>cpu-limit
</code></pre></div>
<p>VÃ©rifiez la consommation CPU du pod :</p>
<div class="highlight"><pre id="__code_48"><span></span><button class="md-clipboard md-icon" title="Copy to clipboard" data-clipboard-target="#__code_48 &gt; code"></button><code><a id="__codelineno-47-1" name="__codelineno-47-1" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-47-1"></a>kubectl<span class="w"> </span>top<span class="w"> </span>pod<span class="w"> </span>cpu-limit
</code></pre></div>
<div class="admonition question">
<p class="admonition-title">Question</p>
<p>Que constatez-vous ? Pourquoi ?</p>
</div>
<p>Supprimez votre pod de test :</p>
<div class="highlight"><pre id="__code_49"><span></span><button class="md-clipboard md-icon" title="Copy to clipboard" data-clipboard-target="#__code_49 &gt; code"></button><code><a id="__codelineno-48-1" name="__codelineno-48-1" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-48-1"></a>kubectl<span class="w"> </span>delete<span class="w"> </span>pod<span class="w"> </span>cpu-limit
</code></pre></div>
<h2 id="etape-2-publication-serviceingress">Ãtape 2 : Publication Service/Ingress</h2>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Vous pouvez maintenant vous placer dans le dossier <code>TP-kube-01/step-2</code> dans lequel vous placerez vos ressources yaml manipulÃ©es pendant cette Ã©tape. Gardez les ressources yaml du step-1 qui pourront vous servir de rÃ©fÃ©rence. </p>
</div>
<p>La plupart du temps l'applicatif qui tourne dans un <code>Pod</code> Kubernetes doit dÃ©livrer un service (que ce soit une Api, un Front ou une base de donnÃ©es, par exemple) et doit donc Ãªtre requÃªtÃ©.</p>
<p>Kubernetes possÃ¨de une ressource spÃ©cifique appelÃ©e <code>Service</code>.</p>
<h3 id="service">Service</h3>
<p>Le <a href="https://kubernetes.io/docs/concepts/services-networking/service/" target="_blank">Service</a> agit comme un Load Balancer qui va transmettre les requÃªtes quâil reÃ§oit vers les Pods auxquels il est rattachÃ©. Ce rattachement se fait grÃ¢ce aux Selector.</p>
<p>Pour publier le Deployment unicorn-front-deployment de l'Ã©tape 1, Ã©ditez le fichier <code>unicorn-front-service.yaml</code> et dÃ©ployez-le avec <code>kubectl apply</code>:</p>
<div class="highlight"><pre id="__code_50"><span></span><button class="md-clipboard md-icon" title="Copy to clipboard" data-clipboard-target="#__code_50 &gt; code"></button><code><a id="__codelineno-49-1" name="__codelineno-49-1" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-49-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<a id="__codelineno-49-2" name="__codelineno-49-2" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-49-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Service</span>
<a id="__codelineno-49-3" name="__codelineno-49-3" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-49-3"></a><span class="nt">metadata</span><span class="p">:</span>
<a id="__codelineno-49-4" name="__codelineno-49-4" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-49-4"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">unicorn-front-service</span>
<a id="__codelineno-49-5" name="__codelineno-49-5" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-49-5"></a><span class="nt">spec</span><span class="p">:</span>
<a id="__codelineno-49-6" name="__codelineno-49-6" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-49-6"></a><span class="w">  </span><span class="nt">selector</span><span class="p">:</span>
<a id="__codelineno-49-7" name="__codelineno-49-7" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-49-7"></a><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">unicorn-front</span>
<a id="__codelineno-49-8" name="__codelineno-49-8" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-49-8"></a><span class="w">  </span><span class="nt">ports</span><span class="p">:</span>
<a id="__codelineno-49-9" name="__codelineno-49-9" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-49-9"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">TCP</span>
<a id="__codelineno-49-10" name="__codelineno-49-10" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-49-10"></a><span class="w">      </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">80</span>
<a id="__codelineno-49-11" name="__codelineno-49-11" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-49-11"></a><span class="w">      </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">80</span>
</code></pre></div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<ul>
<li><code>spec.ports.port</code> est le port sur lequel le service va Ã©couter.</li>
<li><code>spec.ports.targetPort</code> est le port <strong>exposÃ©</strong> par le conteneur sur le pod.</li>
</ul>
</div>
<p>Important : VÃ©rifiez que le targetPort du <strong>service</strong> correspond bien au <strong>containerPort</strong> du deployment (ou du pod). 
Pour Ã©viter de s'emmÃªler les pinceaux, vous pouvez aussi <strong>nommer</strong> le port dans votre <strong>deployment</strong> et l'appeler dans le service (<code>spec.template.spec.containers[].ports[].name</code>).</p>
<p>Par dÃ©faut, les services sont de type <code>ClusterIp</code>, c'est-Ã -dire qu'ils sont accessibles depuis l'intÃ©rieur du cluster Kubernetes (et donc pas publiquement sur internet) mais seulement pour les autres applications qui tournent dans le mÃªme cluster Kubernetes.</p>
<p>Un comportement idÃ©al pour un Backend ou une base de donnÃ©es, mais non adaptÃ© pour le Front dâun portail Web qui doit Ãªtre accessible Ã  des utilisateurs.</p>
<p>Pour exposer ces services, il existe plusieurs solutions. Voici les deux les plus courantes :  </p>
<ul>
<li>Soit faire un service de type <code>NodePort</code> (pour exposer le service sur lâensemble des serveurs Worker du cluster Kubernetes) ou <code>LoadBalancer</code> (pour provisionner un load balancer sur le cloud provider sur lequel il tourne (AWS, GCP, AZURE pour citer les principaux).</li>
<li>Soit faire un <code>Ingress</code> pour les expositions http / https. Câest la solution prÃ©conisÃ©e, car elle permet d'accÃ©der aux applications en utilisant une mÃªme IP publique. Lâingress est en fait un Reverse Proxy (voir Api Gateway) et constitue le point dâentrÃ©e de tous les applicatifs Ã  publier sur le Web. Lâingress transmet ensuite les requÃªtes au service de type ClusterIP.</li>
</ul>
<p>Pour rÃ©sumer, voilÃ  lâidÃ©e :
</p><div class="highlight"><pre id="__code_51"><span></span><button class="md-clipboard md-icon" title="Copy to clipboard" data-clipboard-target="#__code_51 &gt; code"></button><code><a id="__codelineno-50-1" name="__codelineno-50-1" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-50-1"></a>UTILISATEUR â INGRESS â SERVICE â PODS
</code></pre></div><p></p>
<p>Ã noter que lâIngress Controller utilise lui-mÃªme un service de type <code>LoadBalancer</code> ou <code>NodePort</code> partagÃ© par tous les ingress quâil va contrÃ´ler.</p>
<h3 id="ingress">Ingress</h3>
<p>Nous allons maintenant mettre en place un <a href="https://kubernetes.io/docs/concepts/services-networking/ingress/" target="_blank">Ingress</a></p>
<p>Si vous Ãªtes curieux, vous aurez remarquÃ© quâil y a dÃ©jÃ  un <code>IngressClass</code> dans le Cluster qui a Ã©tÃ© provisionnÃ©.
Il sâagit dâun <a href="https://kubernetes.io/docs/concepts/services-networking/ingress-controllers/" target="_blank">Ingress Controller</a> Nginx.</p>
<p>Qui dit Reverse Proxy, dit bien sÃ»r URL. En effet, le Reverse Proxy utilise un ensemble URL+Path pour savoir vers quel service il doit transmettre les requÃªtes. Un DNS a dÃ©jÃ  Ã©tÃ© crÃ©Ã© et vous a Ã©tÃ© transmis par mail.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Le DNS devrait Ãªtre de la forme <code>cequevousvoulez.${namespace}.takima.school</code>
Exemple pour le namespace johndoe : <code>unicorn.johndoe.takima.school</code></p>
</div>
<p>Ãditez un fichier <code>unicorn-front-ingress.yaml</code> et dÃ©ployez-le sur kubernetes :</p>
<div class="highlight"><pre id="__code_52"><span></span><button class="md-clipboard md-icon" title="Copy to clipboard" data-clipboard-target="#__code_52 &gt; code"></button><code><a id="__codelineno-51-1" name="__codelineno-51-1" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-51-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">networking.k8s.io/v1</span>
<a id="__codelineno-51-2" name="__codelineno-51-2" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-51-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Ingress</span>
<a id="__codelineno-51-3" name="__codelineno-51-3" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-51-3"></a><span class="nt">metadata</span><span class="p">:</span>
<a id="__codelineno-51-4" name="__codelineno-51-4" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-51-4"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">unicorn-front-ingress</span>
<a id="__codelineno-51-5" name="__codelineno-51-5" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-51-5"></a><span class="nt">spec</span><span class="p">:</span>
<a id="__codelineno-51-6" name="__codelineno-51-6" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-51-6"></a><span class="w">  </span><span class="nt">ingressClassName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span>
<a id="__codelineno-51-7" name="__codelineno-51-7" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-51-7"></a><span class="w">  </span><span class="nt">rules</span><span class="p">:</span>
<a id="__codelineno-51-8" name="__codelineno-51-8" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-51-8"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">replace-with-your-url</span>
<a id="__codelineno-51-9" name="__codelineno-51-9" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-51-9"></a><span class="w">      </span><span class="nt">http</span><span class="p">:</span>
<a id="__codelineno-51-10" name="__codelineno-51-10" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-51-10"></a><span class="w">        </span><span class="nt">paths</span><span class="p">:</span>
<a id="__codelineno-51-11" name="__codelineno-51-11" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-51-11"></a><span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">backend</span><span class="p">:</span>
<a id="__codelineno-51-12" name="__codelineno-51-12" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-51-12"></a><span class="w">              </span><span class="nt">service</span><span class="p">:</span>
<a id="__codelineno-51-13" name="__codelineno-51-13" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-51-13"></a><span class="w">                </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">unicorn-front-service</span>
<a id="__codelineno-51-14" name="__codelineno-51-14" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-51-14"></a><span class="w">                </span><span class="nt">port</span><span class="p">:</span>
<a id="__codelineno-51-15" name="__codelineno-51-15" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-51-15"></a><span class="w">                  </span><span class="nt">number</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">80</span>
<a id="__codelineno-51-16" name="__codelineno-51-16" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-51-16"></a><span class="w">            </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/</span>
<a id="__codelineno-51-17" name="__codelineno-51-17" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-51-17"></a><span class="w">            </span><span class="nt">pathType</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Prefix</span>
</code></pre></div>
<p>Essayez d'accÃ©der au service.</p>
<div class="admonition check">
<p class="admonition-title">Check</p>
<p>Vous devez avoir les fichiers suivants dans le dossier <code>step-2</code> :
</p><div class="highlight"><pre id="__code_53"><span></span><button class="md-clipboard md-icon" title="Copy to clipboard" data-clipboard-target="#__code_53 &gt; code"></button><code><a id="__codelineno-52-1" name="__codelineno-52-1" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-52-1"></a><span class="w">    </span>.
<a id="__codelineno-52-2" name="__codelineno-52-2" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-52-2"></a><span class="w">    </span>âââ<span class="w"> </span>unicorn-front-service.yaml
<a id="__codelineno-52-3" name="__codelineno-52-3" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-52-3"></a><span class="w">    </span>âââ<span class="w"> </span>unicorn-front-ingress.yaml
</code></pre></div><p></p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Il existe une autre approche utilisant des ressources kubernetes diffÃ©rentes pour publier un applicatif. Cette approche se nomme <code>Gateway API</code>.
Elle se base sur 2 objets qui remplacent l'objet <code>Ingress</code> : 
* la ressource <code>Gateway</code> qui dÃ©finit le point d'accÃ¨s qui permet de rentrer dans le cluster.
* Les <code>Routes</code> (comme les <code>HTTPRoute</code> ou les <code>TLSRoute</code>) qui dÃ©finissent les rÃ¨gles de routage qui enverront le trafic au bon endroit (au bon <code>Service</code> le plus souvent). Les <code>Routes</code> sont associÃ©es Ã  une <code>Gateway</code> qui, elle-mÃªme, implÃ©mente une <code>GatewayClass</code>.
La logique est donc la mÃªme qu'un <code>Ingress</code> (d'ailleurs la technologie sous-jacente est souvent la mÃªme : implÃ©mentation d'un reverse proxy). Mais la logique est bien plus souple ( routes par protocole, gateway cross namespaces, plus comprhensible dans la gestion des header par exemple) et surtout la sÃ©paration des objets permet de mieux dÃ©finir les rÃ´les : objet <code>Gateway</code> plutÃ´t gerÃ© par un Cluster Operator; objet <code>HTTPRoute</code> plutÃ´t developpeur applicatif.
Pour la suite, on continuera d'utiliser la notion d'<code>Ingress</code> qui reste encore le plus rÃ©pandu</p>
</div>
<h3 id="bonus_1">Bonus</h3>
<p>Comme la sÃ©curitÃ©, c'est important, il est possible d'utiliser HTTPS/TLS, mais pas d'inquiÃ©tude, les Ã©ventuels problÃ¨mes de certificats ont Ã©tÃ© rÃ©glÃ©s en amont grÃ¢ce Ã  CertManager. Le CertManager permet aux utilisateurs de crÃ©er un Ingress en demandant l'utilisation d'un <code>cluster-issuer</code> de certificat.</p>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>Nous avons mis deux cluster-issuers dans le Cluster :<br>
 * Un appelÃ© <code>letsencrypt-staging</code> qui vous permet de tout tester avec des certificats de non-production gÃ©nÃ©rÃ©s par letsencrypt.
 * L'autre appelÃ© <code>letsencrypt-prod</code> qui vous permet de vraiment gÃ©nÃ©rer un certificat Let's Encrypt valid.</p>
</div>
<p>Nous vous <strong>recommandons</strong> de d'abord faire vos tests avec <code>letsencrypt-staging</code></p>
<div class="highlight"><pre id="__code_54"><span></span><button class="md-clipboard md-icon" title="Copy to clipboard" data-clipboard-target="#__code_54 &gt; code"></button><code><a id="__codelineno-53-1" name="__codelineno-53-1" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-53-1"></a><span class="w"> </span><span class="nt">annotations</span><span class="p">:</span>
<a id="__codelineno-53-2" name="__codelineno-53-2" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-53-2"></a><span class="w">   </span><span class="nt">cert-manager.io/cluster-issuer</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">letsencrypt-staging</span>
<a id="__codelineno-53-3" name="__codelineno-53-3" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-53-3"></a><span class="w">   </span><span class="nt">kubernetes.io/tls-acme</span><span class="p">:</span><span class="w"> </span><span class="s">'true'</span>
<a id="__codelineno-53-4" name="__codelineno-53-4" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-53-4"></a><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">unicorn-front-ingress</span>
<a id="__codelineno-53-5" name="__codelineno-53-5" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-53-5"></a><span class="nt">spec</span><span class="p">:</span>
<a id="__codelineno-53-6" name="__codelineno-53-6" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-53-6"></a><span class="w"> </span><span class="nt">ingressClassName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span>
<a id="__codelineno-53-7" name="__codelineno-53-7" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-53-7"></a><span class="w"> </span><span class="nt">rules</span><span class="p">:</span>
<a id="__codelineno-53-8" name="__codelineno-53-8" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-53-8"></a><span class="w"> </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">replace-with-your-url</span>
<a id="__codelineno-53-9" name="__codelineno-53-9" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-53-9"></a><span class="w">   </span><span class="nt">http</span><span class="p">:</span>
<a id="__codelineno-53-10" name="__codelineno-53-10" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-53-10"></a><span class="w">     </span><span class="nt">paths</span><span class="p">:</span>
<a id="__codelineno-53-11" name="__codelineno-53-11" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-53-11"></a><span class="w">     </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">backend</span><span class="p">:</span>
<a id="__codelineno-53-12" name="__codelineno-53-12" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-53-12"></a><span class="w">         </span><span class="nt">service</span><span class="p">:</span>
<a id="__codelineno-53-13" name="__codelineno-53-13" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-53-13"></a><span class="w">           </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">unicorn-front-service</span>
<a id="__codelineno-53-14" name="__codelineno-53-14" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-53-14"></a><span class="w">           </span><span class="nt">port</span><span class="p">:</span>
<a id="__codelineno-53-15" name="__codelineno-53-15" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-53-15"></a><span class="w">             </span><span class="nt">number</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">80</span>
<a id="__codelineno-53-16" name="__codelineno-53-16" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-53-16"></a><span class="w">       </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/</span>
<a id="__codelineno-53-17" name="__codelineno-53-17" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-53-17"></a><span class="w">       </span><span class="nt">pathType</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Prefix</span>
<a id="__codelineno-53-18" name="__codelineno-53-18" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-53-18"></a><span class="w"> </span><span class="nt">tls</span><span class="p">:</span>
<a id="__codelineno-53-19" name="__codelineno-53-19" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-53-19"></a><span class="w"> </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">hosts</span><span class="p">:</span>
<a id="__codelineno-53-20" name="__codelineno-53-20" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-53-20"></a><span class="w">   </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">replace-with-your-url</span>
<a id="__codelineno-53-21" name="__codelineno-53-21" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-53-21"></a><span class="w">   </span><span class="nt">secretName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">unicorn-front-tls</span>
</code></pre></div>
<p>VÃ©rifiez lâaccÃ¨s en SSL via votre browser ou via <code>curl</code> / <code>openssl s_client -connect</code>.</p>
<p>Letsencrypt limite le nombre de requÃªtes pour gÃ©nÃ©rer des certificats de production.
Pour ne pas se faire blacklister, nous avons crÃ©Ã© un <code>Wildcard certificate</code> pour chacun d'entre vous.
Pour l'utiliser plus besoin de CertManager ni de TLS acme.
Il suffit d'utiliser le secretName que nous vous avons fourni et qui contient le Wildcard, c'est-Ã -dire : <code>app-wildcard</code></p>
<p>Dans votre Ingress, supprimez les annotations <code>cert-manager.io/cluster-issuer: letsencrypt-staging</code> et <code>kubernetes.io/tls-acme: 'true'</code></p>
<p>Faites un <code>kubectl get secrets</code> pour rÃ©cupÃ©rer le nom du secret wildcard puis ajoutez ce nom dans votre Ingress : au niveau <code>secretName:</code>, Ã  la place de <code>unicorn-front-tls</code></p>
<p>Nous verrons un peu plus tard comment utiliser les secrets.</p>
<h3 id="mise-en-situation">Mise en situation</h3>
<p>Pour bien se rendre compte du fonctionnement du Load Balancing, un Webservice simple a Ã©tÃ© prÃ©parÃ©. Tout d'abord, commencez par nettoyer votre <code>Namespace</code> :</p>
<div class="highlight"><pre id="__code_55"><span></span><button class="md-clipboard md-icon" title="Copy to clipboard" data-clipboard-target="#__code_55 &gt; code"></button><code><a id="__codelineno-54-1" name="__codelineno-54-1" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-54-1"></a>kubectl<span class="w"> </span>delete<span class="w"> </span>--all<span class="w"> </span>deployments
<a id="__codelineno-54-2" name="__codelineno-54-2" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-54-2"></a>kubectl<span class="w"> </span>delete<span class="w"> </span>--all<span class="w"> </span>services
<a id="__codelineno-54-3" name="__codelineno-54-3" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-54-3"></a>kubectl<span class="w"> </span>delete<span class="w"> </span>--all<span class="w"> </span>ingress
</code></pre></div>
<p>Ãditez un nouveau <code>Deployment</code> avec lâimage suivante pour avoir 3 <code>Pods</code> <code>registry.gitlab.com/takima-school/images/simple-website:latest</code>. Vous pouvez nommer le fichier <code>hello-deployment.yaml</code></p>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>Cette image contient un node qui expose ses services sur le port <strong>3000</strong>.</p>
</div>
<div class="admonition question">
<p class="admonition-title">Question</p>
<p>Que se passe-t-il ? Pourquoi ?</p>
</div>
<p>Vous utiliserez la plupart du temps des containers provenant de <code>Container Registry</code> privÃ©s, peu dâentreprises exposant publiquement leurs containers. Il faut alors gÃ©rer les accÃ¨s au Registry privÃ©.</p>
<p>Pour cela, il convient de crÃ©er une nouvelle ressource de type <code>Secret</code> dans Kubernetes. Cette ressource sera dÃ©crite plus en dÃ©tail ultÃ©rieurement.</p>
<p>Pour le moment, crÃ©ez la ressource avec les informations que vous avez reÃ§ues par mail :</p>
<div class="highlight"><pre id="__code_56"><span></span><button class="md-clipboard md-icon" title="Copy to clipboard" data-clipboard-target="#__code_56 &gt; code"></button><code tabindex="0"><a id="__codelineno-55-1" name="__codelineno-55-1" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-55-1"></a>kubectl<span class="w"> </span>create<span class="w"> </span>secret<span class="w"> </span>docker-registry<span class="w"> </span>takima-school-registry<span class="w"> </span>--docker-server<span class="o">=</span>registry.gitlab.com<span class="w"> </span>--docker-username<span class="o">=</span>readregcred<span class="w"> </span>--docker-password<span class="o">=</span>LE_MOT_DE_PASSE_QUE_VOUS_AVEZ_RECU_PAR_MAIL
</code></pre></div>
<p>Puis modifiez votre <code>Deployment</code> pour indiquer que vous souhaitez utiliser ce Secret pour pull lâimage.</p>
<p>Pour cela, Ã©ditez votre yaml, ajoutez y ce block au mÃªme niveau que <code>spec.template.spec</code>:</p>
<div class="highlight"><pre id="__code_57"><span></span><button class="md-clipboard md-icon" title="Copy to clipboard" data-clipboard-target="#__code_57 &gt; code"></button><code><a id="__codelineno-56-1" name="__codelineno-56-1" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-56-1"></a><span class="nt">imagePullSecrets</span><span class="p">:</span>
<a id="__codelineno-56-2" name="__codelineno-56-2" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-56-2"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">takima-school-registry</span>
</code></pre></div>
<p>Une fois le <code>Deployment</code> rÃ©alisÃ© (contrÃ´lez que les <code>Pods</code> ont bien le status running), crÃ©ez un <code>Service</code> ainsi quâun
<code>Ingress</code> pour accÃ©der Ã  la Web App (nouveau fichier <code>hello-service.yaml</code> et <code>hello-ingress.yaml</code>).
Si vous ne l'avez pas fait dans votre <code>Deployment</code>, scalez votre <code>Deployment</code> Ã  3.</p>
<div class="admonition question">
<p class="admonition-title">Question</p>
<p>DÃ©crivez ce que rÃ©pond la Web App ?
Actualisez votre page avec CTRL + F5. Que se passe-t-il ?</p>
</div>
<p>Maintenant, nous allons ajouter des configs de variables d'environement, celles-ci pourront Ãªtre utilisÃ©es dans les containers (et donc dans les applicatifs qui tournent dessus). Ajoutez les variables suivantes dans le deployment (au niveau <code>spec.template.spec.container.env</code>):</p>
<div class="highlight"><pre id="__code_58"><span></span><button class="md-clipboard md-icon" title="Copy to clipboard" data-clipboard-target="#__code_58 &gt; code"></button><code><a id="__codelineno-57-1" name="__codelineno-57-1" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-57-1"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">K8S_NODE_NAME</span>
<a id="__codelineno-57-2" name="__codelineno-57-2" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-57-2"></a><span class="w">  </span><span class="nt">valueFrom</span><span class="p">:</span>
<a id="__codelineno-57-3" name="__codelineno-57-3" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-57-3"></a><span class="w">    </span><span class="nt">fieldRef</span><span class="p">:</span>
<a id="__codelineno-57-4" name="__codelineno-57-4" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-57-4"></a><span class="w">      </span><span class="nt">fieldPath</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">spec.nodeName</span>
<a id="__codelineno-57-5" name="__codelineno-57-5" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-57-5"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">K8S_POD_NAME</span>
<a id="__codelineno-57-6" name="__codelineno-57-6" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-57-6"></a><span class="w">  </span><span class="nt">valueFrom</span><span class="p">:</span>
<a id="__codelineno-57-7" name="__codelineno-57-7" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-57-7"></a><span class="w">    </span><span class="nt">fieldRef</span><span class="p">:</span>
<a id="__codelineno-57-8" name="__codelineno-57-8" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-57-8"></a><span class="w">      </span><span class="nt">fieldPath</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">metadata.name</span>
<a id="__codelineno-57-9" name="__codelineno-57-9" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-57-9"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">K8S_POD_IP</span>
<a id="__codelineno-57-10" name="__codelineno-57-10" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-57-10"></a><span class="w">  </span><span class="nt">valueFrom</span><span class="p">:</span>
<a id="__codelineno-57-11" name="__codelineno-57-11" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-57-11"></a><span class="w">    </span><span class="nt">fieldRef</span><span class="p">:</span>
<a id="__codelineno-57-12" name="__codelineno-57-12" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-57-12"></a><span class="w">      </span><span class="nt">fieldPath</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">status.podIP</span>
</code></pre></div>
<div class="admonition question">
<p class="admonition-title">Question</p>
<p>Que constatez-vous sur le navigateur ?</p>
</div>
<div class="admonition check">
<p class="admonition-title">Check</p>
<p>Vous devez avoir les nouveaux fichiers suivants dans le dossier <code>step-2</code> :
</p><div class="highlight"><pre id="__code_59"><span></span><button class="md-clipboard md-icon" title="Copy to clipboard" data-clipboard-target="#__code_59 &gt; code"></button><code><a id="__codelineno-58-1" name="__codelineno-58-1" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-58-1"></a><span class="w">    </span>.
<a id="__codelineno-58-2" name="__codelineno-58-2" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-58-2"></a><span class="w">    </span>âââ<span class="w"> </span>hello-deployement.yaml
<a id="__codelineno-58-3" name="__codelineno-58-3" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-58-3"></a><span class="w">    </span>âââ<span class="w"> </span>hello-service.yaml
<a id="__codelineno-58-4" name="__codelineno-58-4" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-58-4"></a><span class="w">    </span>âââ<span class="w"> </span>hello-ingress.yaml
</code></pre></div><p></p>
</div>
<h2 id="etape-3-configmapsecret">Ãtape 3 : ConfigMap/Secret</h2>
<p>La plupart du temps lorsque qu'une application est dÃ©ployÃ©e, vous aurez besoin de lui fournir une configuration.
Par exemple, vous lui indiquerez des valeurs pour les variables dâenvironnement (de la mÃªme maniÃ¨re que le <code>.env</code> du Docker Compose).
Bien quâil soit possible de configurer cela âen durâ dans le Pod ou le Deployment, il est d'adage que le concept de hardcoder des configs envoie droit Ã  la catastrophe.
Dans Kubernetes, une ressource est dÃ©diÃ©e pour Ã©viter cette destinÃ©e : il sâagit du <a href="https://kubernetes.io/docs/concepts/configuration/configmap/" target="_blank">ConfigMap</a>.</p>
<p>La plupart du temps un <code>ConfigMap</code> dÃ©fini un couple Key/Value qui sera ensuite utilisÃ© dans le <code>Pod</code> pour configurer des variables d'environnement. Mais vous pourrez aussi dÃ©finir un fichier de configuration entier et le monter comme un volume dans votre <code>Pod</code>.</p>
<h3 id="exemple">Exemple :</h3>
<p>Quelque chose est volontairement cachÃ© dans la Web App de dÃ©mo. En effet, il est possible de lui dÃ©finir une variable dâenvironnement nommÃ©e CUSTOM_COLOR pour forcer la couleur du background.</p>
<p>Pour cela, il faut :</p>
<ul>
<li>CrÃ©er un <code>ConfigMap</code> en configurant cette variable, nouveau fichier <code>hello-config.yaml</code>. </li>
<li>Consommer la variable dans le <code>Deployment</code>.</li>
</ul>
<div class="highlight"><pre id="__code_60"><span></span><button class="md-clipboard md-icon" title="Copy to clipboard" data-clipboard-target="#__code_60 &gt; code"></button><code><a id="__codelineno-59-1" name="__codelineno-59-1" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-59-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<a id="__codelineno-59-2" name="__codelineno-59-2" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-59-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ConfigMap</span>
<a id="__codelineno-59-3" name="__codelineno-59-3" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-59-3"></a><span class="nt">metadata</span><span class="p">:</span>
<a id="__codelineno-59-4" name="__codelineno-59-4" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-59-4"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">web-app</span>
<a id="__codelineno-59-5" name="__codelineno-59-5" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-59-5"></a><span class="nt">data</span><span class="p">:</span>
<a id="__codelineno-59-6" name="__codelineno-59-6" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-59-6"></a><span class="w">  </span><span class="c1"># property-like keys; each key maps to a simple value</span>
<a id="__codelineno-59-7" name="__codelineno-59-7" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-59-7"></a><span class="w">  </span><span class="nt">color</span><span class="p">:</span><span class="w"> </span><span class="s">"#200"</span>
</code></pre></div>
<p>Le bloc suivant est Ã  placer dans le <code>Deployment</code> au niveau du template container (au mÃªme niveau que le name ou lâimage du container utilisÃ© dans le deployment <code>spec.template.spec.container</code>). Attention Ã  l'indentation du yaml !</p>
<div class="highlight"><pre id="__code_61"><span></span><button class="md-clipboard md-icon" title="Copy to clipboard" data-clipboard-target="#__code_61 &gt; code"></button><code tabindex="0"><a id="__codelineno-60-1" name="__codelineno-60-1" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-60-1"></a><span class="nt">env</span><span class="p">:</span>
<a id="__codelineno-60-2" name="__codelineno-60-2" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-60-2"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">CUSTOM_COLOR</span><span class="w"> </span><span class="c1"># Vrai key de la variable d'env. Peut-Ãªtre diffÃ©rent de la valeur dans le configmap</span>
<a id="__codelineno-60-3" name="__codelineno-60-3" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-60-3"></a><span class="w">    </span><span class="nt">valueFrom</span><span class="p">:</span>
<a id="__codelineno-60-4" name="__codelineno-60-4" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-60-4"></a><span class="w">      </span><span class="nt">configMapKeyRef</span><span class="p">:</span>
<a id="__codelineno-60-5" name="__codelineno-60-5" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-60-5"></a><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">web-app</span><span class="w">  </span><span class="c1"># Nom du configmap</span>
<a id="__codelineno-60-6" name="__codelineno-60-6" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-60-6"></a><span class="w">        </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">color</span><span class="w">     </span><span class="c1"># nom de la clef dans le configmap</span>
</code></pre></div>
<h3 id="secret">Secret</h3>
<p>Un <a href="https://kubernetes.io/docs/concepts/configuration/secret/" target="_blank">Secret</a> sâutilise comme un <code>ConfigMap</code> mais sera masquÃ© dans le cluster Kubernetes et vous pourrez appliquer des droits diffÃ©rents sur ces ressources pour avoir des restrictions dâaccÃ¨s. Dâailleurs, pour le crÃ©er, vous devez encoder les donnÃ©es en Base64.</p>
<p>Deux solutions :<br>
 1. Soit directement en Command line avec kubectl create. 
    </p><div class="highlight"><pre id="__code_62"><span></span><button class="md-clipboard md-icon" title="Copy to clipboard" data-clipboard-target="#__code_62 &gt; code"></button><code tabindex="0"><a id="__codelineno-61-1" name="__codelineno-61-1" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-61-1"></a>kubectl<span class="w"> </span>create<span class="w"> </span>secret<span class="w"> </span>generic<span class="w"> </span>my-secret<span class="w"> </span>--from-literal<span class="o">=</span><span class="nv">username</span><span class="o">=</span>user<span class="w"> </span>--from-literal<span class="o">=</span><span class="nv">password</span><span class="o">=</span><span class="s1">'test123*'</span>
</code></pre></div>
    <em>Remarque : dans ce cas, on ne passe pas les data en base 64, la commande s'occupe de cela.</em><br>
 2. Soit via un yaml, mais attention, dans ce cas les valeurs des data doivent Ãªtre en Base64. Il faut donc convertir les valeurs au prÃ©alable :<br>
<div class="highlight"><pre id="__code_63"><span></span><button class="md-clipboard md-icon" title="Copy to clipboard" data-clipboard-target="#__code_63 &gt; code"></button><code><a id="__codelineno-62-1" name="__codelineno-62-1" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-62-1"></a><span class="nb">echo</span><span class="w"> </span>-n<span class="w"> </span><span class="s1">'user'</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>base64
<a id="__codelineno-62-2" name="__codelineno-62-2" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-62-2"></a><span class="nv">dXNlcg</span><span class="o">==</span>
<a id="__codelineno-62-3" name="__codelineno-62-3" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-62-3"></a><span class="nb">echo</span><span class="w"> </span>-n<span class="w"> </span><span class="s1">'test123*'</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>base64
<a id="__codelineno-62-4" name="__codelineno-62-4" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-62-4"></a><span class="nv">dGVzdDEyMyo</span><span class="o">=</span>
</code></pre></div><p></p>
<p>Puis, le yaml peut Ãªtre Ã©ditÃ©, nouveau fichier <code>hello-secret.yaml</code> :</p>
<div class="highlight"><pre id="__code_64"><span></span><button class="md-clipboard md-icon" title="Copy to clipboard" data-clipboard-target="#__code_64 &gt; code"></button><code><a id="__codelineno-63-1" name="__codelineno-63-1" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-63-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<a id="__codelineno-63-2" name="__codelineno-63-2" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-63-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Secret</span>
<a id="__codelineno-63-3" name="__codelineno-63-3" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-63-3"></a><span class="nt">metadata</span><span class="p">:</span>
<a id="__codelineno-63-4" name="__codelineno-63-4" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-63-4"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">hello-secret</span>
<a id="__codelineno-63-5" name="__codelineno-63-5" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-63-5"></a><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Opaque</span>
<a id="__codelineno-63-6" name="__codelineno-63-6" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-63-6"></a><span class="nt">data</span><span class="p">:</span>
<a id="__codelineno-63-7" name="__codelineno-63-7" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-63-7"></a><span class="w">  </span><span class="nt">username</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">YWRtaW4=</span>
<a id="__codelineno-63-8" name="__codelineno-63-8" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-63-8"></a><span class="w">  </span><span class="nt">password</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">MWYyZDFlMmU2N2Rm</span>
</code></pre></div>
<p>Il ne reste plus qu'Ã  kubectl apply le fichier. VÃ©rifier avec Lens par exemple que le secret est crÃ©Ã©.
Avec Lens, vous pouvez visualiser le contenu du secret en cliquant sur l'Åil.</p>
<div class="admonition check">
<p class="admonition-title">Check</p>
<p>Vous devriez avoir les fichiers suivants dans le dossier <code>step-3</code> :
</p><div class="highlight"><pre id="__code_65"><span></span><button class="md-clipboard md-icon" title="Copy to clipboard" data-clipboard-target="#__code_65 &gt; code"></button><code><a id="__codelineno-64-1" name="__codelineno-64-1" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-64-1"></a><span class="w">    </span>.
<a id="__codelineno-64-2" name="__codelineno-64-2" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-64-2"></a><span class="w">    </span>âââ<span class="w"> </span>hello-config.yaml
<a id="__codelineno-64-3" name="__codelineno-64-3" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-64-3"></a><span class="w">    </span>âââ<span class="w"> </span>hello-secret.yaml
</code></pre></div><p></p>
</div>
<h3 id="bonus_2">Bonus</h3>
<h4 id="bonus-1-rendre-sa-couleur-secrete">Bonus 1 : Rendre sa couleur secrÃ¨te</h4>
<p>Afin d'Ã©viter que votre couleur prÃ©fÃ©rÃ©e soit connue de tous, passez la variable du code couleur en mode <code>Secret</code>. Bonne chance !</p>
<h4 id="bonus-2-mon-pod-est-il-en-vie">Bonus 2 : Mon pod est-il en vie ?</h4>
<p>Il peut arriver parfois que notre application dÃ©marre et soit capable de fonctionner de maniÃ¨re nominale pendant un temps
avant de voir son service se dÃ©grader (apparition d'un deadlock qui empÃªche l'application de fonctionner normalement).</p>
<p>Ce genre d'erreur peut survenir sans pour autant que votre application s'arrÃªte d'elle-mÃªme. Dans ce cas-lÃ , il convient de
fournir Ã  kubernetes un moyen de savoir si l'application devrait Ãªtre redÃ©marrÃ©e ou non. </p>
<p>Cela tombe bien puisque notre application <strong>hello-world</strong> propose un endpoint sur <code>/health</code> donnant l'information sur son
Ã©tat courant. ParamÃ©trez votre <code>Deployment</code> pour qu'il fasse un appel rÃ©gulier sur ce fameux endpoint <code>/health</code>. Pour vÃ©rifier
que tout marche bien, vous pouvez changer l'Ã©tat du healthcheck en faisant une requÃªte <strong>GET</strong> sur l'endpoint <code>/kill</code>. Une fois
fait, l'un de vos pods devraient redÃ©marrer.</p>
<h4 id="bonus-3-let-my-kubernetes-scale">Bonus 3 : Let my kubernetes Scale !!!</h4>
<p>Comme promis, voici une mise en pratique du <a href="https://kubernetes.io/docs/reference/kubernetes-api/workload-resources/horizontal-pod-autoscaler-v2/" target="_blank">HPA</a>,
la mise Ã  l'Ã©chelle automatique d'un dÃ©ploiement.
Pour cela, commencez par supprimer vos ressources <code>dÃ©ployment</code> existantes (pour avoir de la visibilitÃ©).</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Le <strong>HPA</strong> se base sur les ressources request dÃ©finies dans votre dÃ©ploiement.
En effet, on va dÃ©finir un pourcentage basÃ© sur ces ressources.
Nous vous conseillons donc de rÃ©aliser le bonus de l'Ã©tape 1, qui traite de cela avant de continuer.</p>
</div>
<p>Nous avons prÃ©parÃ© pour vous un petit applicatif qui simule une charge Ã  chaque fois qu'il reÃ§oit une requÃªte http.</p>
<p>Commencez par Ã©diter et deployer le fichier <code>hpa-deployment.yaml</code> avec :</p>
<ul>
<li>image : <code>registry.gitlab.com/takima-school/images/hpa:latest</code></li>
<li>replicas Ã  <code>1</code></li>
<li>nom <code>hpa</code> et label <code>app: hpa</code></li>
<li>les ressources suivantes :</li>
</ul>
<div class="highlight"><pre id="__code_66"><span></span><button class="md-clipboard md-icon" title="Copy to clipboard" data-clipboard-target="#__code_66 &gt; code"></button><code><a id="__codelineno-65-1" name="__codelineno-65-1" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-65-1"></a><span class="w">        </span><span class="nt">resources</span><span class="p">:</span>
<a id="__codelineno-65-2" name="__codelineno-65-2" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-65-2"></a><span class="w">          </span><span class="nt">limits</span><span class="p">:</span>
<a id="__codelineno-65-3" name="__codelineno-65-3" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-65-3"></a><span class="w">            </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">500m</span>
<a id="__codelineno-65-4" name="__codelineno-65-4" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-65-4"></a><span class="w">          </span><span class="nt">requests</span><span class="p">:</span>
<a id="__codelineno-65-5" name="__codelineno-65-5" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-65-5"></a><span class="w">            </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">200m</span>
</code></pre></div>
<ul>
<li>la mise en place du <code>imagePullSecrets</code> car on pull un registry privÃ©.</li>
</ul>
<p>Ãditez et dÃ©ployez ensuite le service correspondant :</p>
<ul>
<li>targetPort: 80</li>
<li>Port: 80</li>
<li>nom: hpa</li>
</ul>
<p>VoilÃ  le socle est prÃªt pour mettre Ã  l'Ã©chelle notre application :</p>
<ul>
<li>Mettez en place le hpa sur le dÃ©ploiement :</li>
</ul>
<p><code>kubectl autoscale deployment hpa --cpu-percent=50 --min=1 --max=10</code></p>
<p>Ici, on demande de scaler l'application dÃ¨s que la ressource cpu dÃ©passe 50% du request (ici donc 100m cpu).</p>
<p>VÃ©rifiez l'Ã©tat du <strong>HPA</strong> (on peut aussi le voir dans LENS)</p>
<div class="highlight"><pre id="__code_67"><span></span><button class="md-clipboard md-icon" title="Copy to clipboard" data-clipboard-target="#__code_67 &gt; code"></button><code><a id="__codelineno-66-1" name="__codelineno-66-1" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-66-1"></a>laptop-3007:~$ kubectl get hpa
<a id="__codelineno-66-2" name="__codelineno-66-2" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-66-2"></a>NAME   REFERENCE        TARGETS   MINPODS   MAXPODS   REPLICAS   AGE
<a id="__codelineno-66-3" name="__codelineno-66-3" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-66-3"></a>hpa    Deployment/hpa   0%/50%    1         10        1          105s
</code></pre></div>
<p>On voit qu'il n'est pas trÃ¨s chargÃ©. Mais cela ne va pas durer !</p>
<p>Pour gÃ©nÃ©rer du traffic rien de tel qu'un pod qui attaque le service. Sur un autre terminal, lancez cette commande et laissez la tourner en fond :</p>
<p><code>kubectl run -i --tty load-generator --rm --image=registry.takima.io/school/proxy/busybox --restart=Never -- /bin/sh -c "while sleep 0.01; do wget -q -O- http://hpa; done"</code></p>
<p>Puis, commencez Ã  observer la charge monter sur votre dÃ©ploiement en lanÃ§ant plusieurs <code>kubectl get hpa</code> ou avec un <code>watch</code>(ici Ã  160%)</p>
<div class="highlight"><pre id="__code_68"><span></span><button class="md-clipboard md-icon" title="Copy to clipboard" data-clipboard-target="#__code_68 &gt; code"></button><code><a id="__codelineno-67-1" name="__codelineno-67-1" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-67-1"></a>laptop-3007:~$ kubectl get hpa
<a id="__codelineno-67-2" name="__codelineno-67-2" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-67-2"></a>NAME   REFERENCE        TARGETS    MINPODS   MAXPODS   REPLICAS   AGE
<a id="__codelineno-67-3" name="__codelineno-67-3" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-67-3"></a>hpa    Deployment/hpa   160%/50%   1         10        1          108s
</code></pre></div>
<div class="admonition question">
<p class="admonition-title">Question</p>
<p>Observez ce qu'il se passe. Que constatez-vous ?</p>
</div>
<p>Voici ce qui est attendu :</p>
<p><img alt="scaling hpa" src="./Day 1 - Discovery - Kubernetes in action_files/hpa_scale.png"></p>
<p>On voit bien notre applicatif scaler Ã  6 pods. On le constate aussi si l'on fait un <code>kubectl get pods</code> d'ailleurs.</p>
<p>De plus nous pouvons lancer un <code>kubectl describe hpa hpa</code>  pour regarder les logs du hpa et ces Ã©vÃ©nements :</p>
<p><img alt="scaling hpa" src="./Day 1 - Discovery - Kubernetes in action_files/hpa_scale_logshpa.png"></p>
<p>Les logs parlent d'eux-mÃªmes !</p>
<p>Maintenant, coupez le process qui tourne en fond sur votre deuxiÃ¨me terminal.</p>
<p>On remarque que la charge a diminuÃ© avec un <code>kubectl get hpa</code></p>
<p>Et au bout de quelques minutes le hpa devrait downscale l'applicatif. Par dÃ©fault, pour des raisons de stabilisation, le downscaling ne se fait qu'aprÃ¨s 300 secondes sous le dÃ©clencheur (dans notre cas 50% de cpu request). Attendez donc un peu et vÃ©rifiez que le dÃ©ploiement repasse Ã  1 replicas.</p>
<p><img alt="scaling hpa" src="./Day 1 - Discovery - Kubernetes in action_files/hpa_downscale_logshpa.png"></p>
<div class="admonition check">
<p class="admonition-title">Check</p>
<p>Vous devriez avoir 2 nouveaux fichiers dans le dossier <code>hpa</code> :
</p><div class="highlight"><pre id="__code_69"><span></span><button class="md-clipboard md-icon" title="Copy to clipboard" data-clipboard-target="#__code_69 &gt; code"></button><code><a id="__codelineno-68-1" name="__codelineno-68-1" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-68-1"></a><span class="w">    </span>.
<a id="__codelineno-68-2" name="__codelineno-68-2" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-68-2"></a><span class="w">    </span>âââ<span class="w"> </span>hpa-deployment.yaml
<a id="__codelineno-68-3" name="__codelineno-68-3" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-68-3"></a><span class="w">    </span>âââ<span class="w"> </span>hpa-service.yaml
</code></pre></div><p></p>
</div>
<h4 id="bonus-4-control-my-traffic">Bonus 4: Control my traffic !!!</h4>
<p>Ici, nous allons voir comment utiliser une nouvelle ressource pour contrÃ´ler finement les flux entre les Pods. Cette ressource se nomme <code>NetworkPolicy</code>.</p>
<p>Par dÃ©faut comme vous l'avez surement dÃ©jÃ  constatÃ©, tout est open ! Et parfois (voire souvent) ce n'est pas une bonne pratique.</p>
<p>Attention : la NetworkPolicy est une fonctionnalitÃ© qui n'est pas prise en charge par tous les <strong>CNI (Controller Network Interface)</strong>.
Comme le CNI n'est pas l'objet de cette formation, sachez simplement que c'est une API de gestion du rÃ©seau d'un cluster K8S. Il existe une multitude d'implÃ©mentations, ici, nous avons provisionnÃ© un cluster avec un CNI qui prend en charge les NetworkPolicies (<strong>Calico</strong> en l'occurrence).</p>
<p>Pour comprendre comment cela fonctionne, commencez par deployer une ressource que vous maitrisez sur le bout des doigts : un <code>deployment</code>.</p>
<div class="highlight"><pre id="__code_70"><span></span><button class="md-clipboard md-icon" title="Copy to clipboard" data-clipboard-target="#__code_70 &gt; code"></button><code tabindex="0"><a id="__codelineno-69-1" name="__codelineno-69-1" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-69-1"></a>kubectl<span class="w"> </span>create<span class="w"> </span>deployment<span class="w"> </span>nginx<span class="w"> </span>--image<span class="o">=</span>registry.takima.io/school/proxy/nginx:1.7.9
</code></pre></div>
<p>Ensuite, exposez ce deployment Ã  travers un service : </p>
<div class="highlight"><pre id="__code_71"><span></span><button class="md-clipboard md-icon" title="Copy to clipboard" data-clipboard-target="#__code_71 &gt; code"></button><code><a id="__codelineno-70-1" name="__codelineno-70-1" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-70-1"></a>kubectl<span class="w"> </span>expose<span class="w"> </span>deployment<span class="w"> </span>nginx<span class="w"> </span>--port<span class="o">=</span><span class="m">80</span>
</code></pre></div>
<p>Pour tester les accÃ¨s en interne, on lance la boite Ã  outils busybox :</p>
<div class="highlight"><pre id="__code_72"><span></span><button class="md-clipboard md-icon" title="Copy to clipboard" data-clipboard-target="#__code_72 &gt; code"></button><code tabindex="0"><a id="__codelineno-71-1" name="__codelineno-71-1" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-71-1"></a>kubectl<span class="w"> </span>run<span class="w"> </span>busybox<span class="w"> </span>--rm<span class="w"> </span>-ti<span class="w"> </span>--image<span class="o">=</span>registry.takima.io/school/proxy/busybox:1.28<span class="w"> </span>--<span class="w"> </span>/bin/sh
</code></pre></div>
<p>Cela va vous ouvrir un shell dans votre pod busybox (qui se trouve dans le mÃªme namespace que votre nginx).
Vous pouvez tester que vous pouvez accÃ©der Ã  votre nginx :</p>
<div class="highlight"><pre id="__code_73"><span></span><button class="md-clipboard md-icon" title="Copy to clipboard" data-clipboard-target="#__code_73 &gt; code"></button><code><a id="__codelineno-72-1" name="__codelineno-72-1" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-72-1"></a>wget<span class="w"> </span>--spider<span class="w"> </span>--timeout<span class="o">=</span><span class="m">1</span><span class="w"> </span>nginx
</code></pre></div>
<p>La connection doit passer (car comme on l'a dit par default si on ne fait rien, c'est ouvert).</p>
<p>Maintenant, quittez votre shell busybox (le pod va s'autodÃ©truire !!)</p>
<p>Appliquez une NetworkPolicy qui va limiter les accÃ¨s au nginx :</p>
<div class="highlight"><pre id="__code_74"><span></span><button class="md-clipboard md-icon" title="Copy to clipboard" data-clipboard-target="#__code_74 &gt; code"></button><code><a id="__codelineno-73-1" name="__codelineno-73-1" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-73-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">networking.k8s.io/v1</span>
<a id="__codelineno-73-2" name="__codelineno-73-2" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-73-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">NetworkPolicy</span>
<a id="__codelineno-73-3" name="__codelineno-73-3" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-73-3"></a><span class="nt">metadata</span><span class="p">:</span>
<a id="__codelineno-73-4" name="__codelineno-73-4" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-73-4"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">access-nginx</span>
<a id="__codelineno-73-5" name="__codelineno-73-5" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-73-5"></a><span class="nt">spec</span><span class="p">:</span>
<a id="__codelineno-73-6" name="__codelineno-73-6" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-73-6"></a><span class="w">  </span><span class="nt">podSelector</span><span class="p">:</span>
<a id="__codelineno-73-7" name="__codelineno-73-7" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-73-7"></a><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span>
<a id="__codelineno-73-8" name="__codelineno-73-8" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-73-8"></a><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span>
<a id="__codelineno-73-9" name="__codelineno-73-9" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-73-9"></a><span class="w">  </span><span class="nt">ingress</span><span class="p">:</span>
<a id="__codelineno-73-10" name="__codelineno-73-10" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-73-10"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">from</span><span class="p">:</span>
<a id="__codelineno-73-11" name="__codelineno-73-11" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-73-11"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">podSelector</span><span class="p">:</span>
<a id="__codelineno-73-12" name="__codelineno-73-12" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-73-12"></a><span class="w">        </span><span class="nt">matchLabels</span><span class="p">:</span>
<a id="__codelineno-73-13" name="__codelineno-73-13" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-73-13"></a><span class="w">          </span><span class="nt">access</span><span class="p">:</span><span class="w"> </span><span class="s">"true"</span>
</code></pre></div>
<p>Re-testez la mÃªme connexion au nginx via busybox :</p>
<div class="highlight"><pre id="__code_75"><span></span><button class="md-clipboard md-icon" title="Copy to clipboard" data-clipboard-target="#__code_75 &gt; code"></button><code tabindex="0"><a id="__codelineno-74-1" name="__codelineno-74-1" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-74-1"></a>kubectl<span class="w"> </span>run<span class="w"> </span>busybox<span class="w"> </span>--rm<span class="w"> </span>-ti<span class="w"> </span>--image<span class="o">=</span>registry.takima.io/school/proxy/busybox:1.28<span class="w"> </span>--<span class="w"> </span>/bin/sh
</code></pre></div>
<div class="highlight"><pre id="__code_76"><span></span><button class="md-clipboard md-icon" title="Copy to clipboard" data-clipboard-target="#__code_76 &gt; code"></button><code><a id="__codelineno-75-1" name="__codelineno-75-1" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-75-1"></a>wget<span class="w"> </span>--spider<span class="w"> </span>--timeout<span class="o">=</span><span class="m">1</span><span class="w"> </span>nginx
</code></pre></div>
<div class="admonition question">
<p class="admonition-title">Question</p>
<p>Que constatez-vous ?</p>
</div>
<p>Quittez votre busybox shell.</p>
<p>Maintenant, ajoutez le label permettant Ã  votre pod busybox de matcher la rÃ¨gle spÃ©cifiÃ©e dans la <code>NetworkPolicy</code> et re-testez la connection :</p>
<div class="highlight"><pre id="__code_77"><span></span><button class="md-clipboard md-icon" title="Copy to clipboard" data-clipboard-target="#__code_77 &gt; code"></button><code tabindex="0"><a id="__codelineno-76-1" name="__codelineno-76-1" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-76-1"></a>kubectl<span class="w"> </span>run<span class="w"> </span>busybox<span class="w"> </span>--rm<span class="w"> </span>-ti<span class="w"> </span>--labels<span class="o">=</span><span class="s2">"access=true"</span><span class="w"> </span>--image<span class="o">=</span>registry.takima.io/school/proxy/busybox:1.28<span class="w"> </span>--<span class="w"> </span>/bin/sh
</code></pre></div>
<p>Testez la connection :</p>
<div class="highlight"><pre id="__code_78"><span></span><button class="md-clipboard md-icon" title="Copy to clipboard" data-clipboard-target="#__code_78 &gt; code"></button><code><a id="__codelineno-77-1" name="__codelineno-77-1" href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch1-discover-kubernetes/#__codelineno-77-1"></a>wget<span class="w"> </span>--spider<span class="w"> </span>--timeout<span class="o">=</span><span class="m">1</span><span class="w"> </span>nginx
</code></pre></div>
<h4 id="bonus-5-run-on-one-az">Bonus 5: Run on one AZ</h4>
<p>Le but ici est d'utiliser le concept d'<code>affinity</code> pour faire tourner les pods de notre dÃ©ployment sur un seul AZ</p>
<div class="admonition question">
<p class="admonition-title">Question</p>
<p>Qu'est-ce qu'une <code>Avaibility Zone</code> au niveau infrastructure ?</p>
</div>
<p>Ici, on a 3 AZ dans la rÃ©gion de Paris sur AWS (rÃ©gion <code>eu-west-3</code>)</p>
<div class="admonition question">
<p class="admonition-title">Question</p>
<p>Faire en sorte de tourner sur une seule AZ, par exemple <code>eu-west-3a</code></p>
</div>
<div class="admonition note">
<p class="admonition-title">indice</p>
<p>les serveurs du cluster kubernetes ont une clef <code>topology.kubernetes.io/zone</code> qui dÃ©finit sur quel AZ ils tournent.</p>
</div>
<p>Pour valider cela, vÃ©rifiez avec un intervenant que tes pods tournent bien sÃ»r les bons serveurs</p>
<h4 id="bonus-6-run-one-pod-on-each-server">Bonus 6: Run one pod on each server</h4>
<p>CrÃ©ez un dÃ©ployment qui va faire tourner vos pods sur chacun des worker nodes du cluster kubernetes avec l'image <code>registry.takima.io/school/proxy/nginx:1.7.9</code></p>
<div class="admonition note">
<p class="admonition-title">indice</p>
<p>il existe une ressource spÃ©ciale qui fait cela, Ã  toi de la trouver.</p>
</div>
<h4 id="bonus-7-change-my-rolling-update-policy">Bonus 7: Change my rolling update policy</h4>
<p>Par dÃ©faut, vous utilisez une policy pour vos upgrades des dÃ©ploiements. Changez cette policy pour avoir un type <code>recreate</code></p>
<p>Utilisez l'image <code>registry.takima.io/school/proxy/nginx:1.7.9</code> avec un replicas Ã  <code>5</code></p>
<p>Mettez Ã  jour votre deployment vers une nouvelle image nginx : <code>registry.takima.io/school/proxy/nginx:1.9.1</code></p>
<div class="admonition question">
<p class="admonition-title">Question</p>
<p>que se passe-t-il au niveau de vos pods pendant l'update ?</p>
</div>

              
            </article>
          </div>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        
        <a href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Briefing" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"></path></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Briefing
            </div>
          </div>
        </a>
      
      
        
        <a href="http://school.pages.takima.io/kubernetes-01/k8s-trainees/ch2-deep-dive/" class="md-footer__link md-footer__link--next" aria-label="Next: Day 2 - Deep Dive" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              Day 2 - Deep Dive
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"></path></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright Â© 2023 - 2024 Takima
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "..", "features": ["navigation.tabs", "navigation.instant"], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing", "select.version.title": "Select version"}, "search": "../assets/javascripts/workers/search.c7dec7e7.min.js"}</script>
    
    
      <script src="./Day 1 - Discovery - Kubernetes in action_files/bundle.da79ceb7.min.js"></script>
      
    
  
</body></html>